
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Chasing Rabbits</title>
  <meta name="author" content="Erick Tryzelaar">

  
  <meta name="description" content="I just pushed up serde 0.3.1 to
crates.io, which is now compatible with beta!
serde_macros 0.3.1, however still requires nightly. But this means that &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://erickt.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Chasing Rabbits" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32180054-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Chasing Rabbits</a></h1>
  
    <h2>A poorly updated blog about what I&#8217;m working on</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:erickt.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/12/serde-0-dot-3-1-now-compatible-with-beta/">Serde 0.3.1 - Now Compatible With Beta! Plus Aster and Quasi Updates</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-12T11:53:43-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:53 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I just pushed up <a href="https://github.com/erickt/rust-serde">serde</a> 0.3.1 to
<a href="https://crates.io/crates/serde">crates.io</a>, which is now compatible with beta!
serde_macros 0.3.1, however still requires nightly.  But this means that if
you implement the all the traits using stable features, then any users of serde
should work with rust 1.0.</p>

<p>Here&rsquo;s what&rsquo;s also new in serde v0.3.1:</p>

<ul>
<li>Renamed <code>ValueDeserializer::deserializer</code> into <code>ValueDeserializer::into_deserializer</code>.</li>
<li>Renamed the attribute that changes the name a field is serialized
<code>#[serde(alias="...")]</code> to <code>#[serde(rename="...")]</code>.</li>
<li>Added implementations for <code>Box</code>, <code>Rc</code>, and <code>Arc</code>.</li>
<li>Updated <code>VariantVisitor</code> to hint to the deserializer which variant kind it is expecting.
This allows serializers to serialize a unit variant as a string.</li>
<li>Added an <code>Error::unknown_field_error</code> error message.</li>
<li>Progress on the documentation, but there&rsquo;s still plenty more to go.</li>
</ul>


<p>Upstream of serde, I&rsquo;ve been also doing some work on
<a href="https://github.com/erickt/rust-aster">aster</a> and
<a href="https://github.com/erickt/rust-quasi">quasi</a>, which are my helper libraries to
simplify writing syntax extensions.</p>

<p>aster v0.2.0:</p>

<ul>
<li>Added builders for qualified paths, slices, <code>Vec</code>, <code>Box</code>, <code>Rc</code>, and <code>Arc</code>.</li>
<li>Extended item builders to support <code>use</code> simple paths, globs, and lists.</li>
<li>Added a helper for building the <code>#[automatically_derived]</code> annotation.</li>
</ul>


<p>quasi v0.1.9:</p>

<ul>
<li>Backported support for <code>quote_attr!()</code> and <code>quote_matchers!()</code> from <code>libsyntax</code>.</li>
<li>Added support for unquoting arbitrary slices.</li>
</ul>


<p>Thanks for everyone&rsquo;s help with this release!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/31/serde-0-dot-3/">Serde 0.3</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-03-31T19:57:37-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>31</span><span class='date-suffix'>st</span>, <span class='date-year'>2015</span></span> <span class='time'>7:57 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m happy to announce that I&rsquo;ve released
<a href="https://github.com/erickt/rust-serde">serde</a> 0.3 on
<a href="https://crates.io/crates/serde">crates.io</a> today.  For those unfamiliar with
serde, it&rsquo;s a generic serialization framework, much like
<a href="https://github.com/rust-lang/rustc-serialize/">rustc-serialize</a>, but much more
powerful. Check out my <a href="http://erickt.github.io/blog/categories/serialization/">serialization series</a>
if you&rsquo;re interested in serde&rsquo;s original development.</p>

<p>There&rsquo;s been a ton of work since 0.2. Here are the highlights:</p>

<ul>
<li><p>Ported over from std::old_io to std::io. There is a bit of a performance hit
when serializing to <code>&amp;mut [u8]</code>, although it&rsquo;s really not that bad. In my goser
benchmarks, previously it ran in 373 MB/s, but now it&rsquo;s running at 260 MB/s.
However, this hasn&rsquo;t impacted the <code>Vec&lt;u8&gt;</code> serialization performance, nor
deserialization performance.</p></li>
<li><p>Much better JSON deserialization errors. Now <code>std::io::Error</code> is properly
propogated, and error locations are reported when a <code>Deserialize</code> raises an error.</p></li>
<li><p>Merged <code>serde::ser::Serializer</code> and <code>serde::ser::Visitor</code>.</p></li>
<li><p>Renamed <code>serde::ser::Serialize::visit</code> to <code>serde::ser::Serialize::serialize</code>.</p></li>
<li><p>Replaced <code>serde::ser::{Seq,Map}Visitor::size_hint</code> with a <code>len()</code> method that
returns an optional length. This has a little stronger emphasis that we either
need an exactly length or no length. Formats that need an exact length should
make sure to verify the length passed in matches the actual amount of values
serialized.</p></li>
<li><p><code>serde::json</code> now deserializes missing values as a <code>()</code>.</p></li>
<li><p>Finished implementing <code>#[derive(Serialize, Deserialize)]</code> for all struct and
enum forms.</p></li>
<li><p>Ported <code>serde_macros</code> over to <a href="https://github.com/erickt/rust-aster">aster</a>
and <a href="https://github.com/erickt/rust-quasi">quasi</a>, which simplies code
generation.</p></li>
<li><p>Removed the unnessary <code>first</code> argument from <code>visit_{seq,map}_elt</code>.</p></li>
<li><p>Rewrote enum deserializations to not require allocations. Oddly enough this
is a tad slower than the allocation form. I suspect it&rsquo;s coming from the
function calls not getting inlined away.</p></li>
<li><p>Allowed enum serialization and deserialization to support more than one
variant.</p></li>
<li><p>Allowed <code>Deserialize</code> types to hint that it&rsquo;s expecting a sequence or a map.</p></li>
<li><p>Allowed maps to be deserialized from a <code>()</code>.</p></li>
<li><p>Added a <code>serde::bytes::{Bytes,ByteBuf}</code>, which wrap <code>&amp;[u8]</code>/<code>Vec&lt;u8&gt;</code> to allow
some formats to encode these values more efficiently than generic sequences.</p></li>
<li><p>Added <code>serde::de::value</code>, which contains some helper deserializers to
deserialize from a Rust type.</p></li>
<li><p>Added impls for most collection types in the standard library.</p></li>
</ul>


<p>Thanks everyone that&rsquo;s helped out with this release!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/16/rewriting-rust-serialization-there-can-be-only-one-serde/">Rewriting Rust Serialization: Part 4: Serde2 Is Ready!</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-16T07:32:54-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>16</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:32 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&rsquo;s been a while, hasn&rsquo;t it? Here&rsquo;s
<a href="http://erickt.github.io/blog/2014/10/28/serialization/">part 1</a>,
<a href="http://erickt.github.io/blog/2014/11/03/performance/">part 2</a>,
<a href="http://erickt.github.io/blog/2014/11/03/performance/">part 2.1</a>,
<a href="http://erickt.github.io/blog/2014/11/03/performance/">part 2.2</a>,
<a href="http://erickt.github.io/blog/2014/12/13/rewriting-rust-serialization/">part 3</a>, and
<a href="http://erickt.github.io/blog/2014/12/13/performance-digression/">part 3.1</a>
if you want to catch up.</p>

<h2>Serde Version 2</h2>

<p>Well it&rsquo;s a long time coming, but serde2 is finally in a mostly usable
position! If you recall from
<a href="http://erickt.github.io/blog/2014/12/13/rewriting-rust-serialization/">part 3</a>,
one of the problems with serde1 is that we&rsquo;re paying a lot for tagging our
types, and it&rsquo;s really hurting us on the deserialization side of things. So
there&rsquo;s one other pattern that we can use that allows for lookahead that
doesn&rsquo;t need tags: visitors. A year or so ago I rewrote our generic hashing
framework to use the visitor pattern to great success. <code>serde2</code> came out of
experiments to see if I could do the same thing here. It turned out that it was
a really elegant approach.</p>

<h3>Serialize</h3>

<p>It all starts with a type that we want to serialize:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Serialize</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Visitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">V</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>(Aside: while I&rsquo;d rather use <code>where</code> here for this type parameter, that would
force me to write <code>&lt;V as Visitor&gt;::Value&gt;</code> due to
<a href="https://github.com/rust-lang/rust/issues/20300">#20300</a>).</p>

<p>This <code>Visitor</code> trait then looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Visitor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Value</span><span class="p">;</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_unit</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_named_unit</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_name</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">visit_unit</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_bool</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the implementation for a <code>bool</code> then looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">Serialize</span> <span class="k">for</span> <span class="kt">bool</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Visitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">V</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">visitor</span><span class="p">.</span><span class="n">visit_bool</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Things get more interesting when we get to compound structures like a sequence.
Here&rsquo;s <code>Visitor</code> again. It needs to both be able to visit the overall structure
as well as each item:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">visit_seq</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">where</span> <span class="n">V</span><span class="o">:</span> <span class="n">SeqVisitor</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">visit_seq_elt</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">first</span><span class="o">:</span> <span class="kt">bool</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">value</span><span class="o">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">where</span> <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We also have this <code>SeqVisitor</code> trait that the type to serialize provides. It
really just looks like an <code>Iterator</code>, but the type parameter has been moved to
the <code>visit</code> method so that it can return different types:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">SeqVisitor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Visitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">V</span><span class="o">::</span><span class="n">Value</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">size_hint</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">usize</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">usize</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, to implement this for a type like <code>&amp;[T]</code> we create an
<code>Iterator</code>-to-<code>SeqVisitor</code> adaptor and pass it to the visitor, which then in
turn visits each item:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">struct</span> <span class="n">SeqIteratorVisitor</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">iter</span><span class="o">:</span> <span class="n">Iter</span><span class="p">,</span>
</span><span class='line'>    <span class="n">first</span><span class="o">:</span> <span class="kt">bool</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Iter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">=</span><span class="n">T</span><span class="o">&gt;&gt;</span> <span class="n">SeqIteratorVisitor</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">new</span><span class="p">(</span><span class="n">iter</span><span class="o">:</span> <span class="n">Iter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeqIteratorVisitor</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SeqIteratorVisitor</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">iter</span><span class="o">:</span> <span class="n">iter</span><span class="p">,</span>
</span><span class='line'>            <span class="n">first</span><span class="o">:</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span>
</span><span class='line'>    <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Iter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">=</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">SeqVisitor</span> <span class="k">for</span> <span class="n">SeqIteratorVisitor</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Visitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">V</span><span class="o">::</span><span class="n">Value</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">match</span> <span class="bp">self</span><span class="p">.</span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Some</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">visitor</span><span class="p">.</span><span class="n">visit_seq_elt</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>
</span><span class='line'>                <span class="nb">Ok</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nb">None</span> <span class="o">=&gt;</span> <span class="nb">Ok</span><span class="p">(</span><span class="nb">None</span><span class="p">),</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">size_hint</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">usize</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">usize</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">iter</span><span class="p">.</span><span class="n">size_hint</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span>
</span><span class='line'>    <span class="nl">&#39;a</span><span class="p">,</span>
</span><span class='line'>    <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="p">,</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">Serialize</span> <span class="k">for</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Visitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">V</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">visitor</span><span class="p">.</span><span class="n">visit_seq</span><span class="p">(</span><span class="n">SeqIteratorVisitor</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">iter</span><span class="p">()))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>SeqIteratorVisitor</code> is publically exposed, so it should be easy to use it with
custom data structures. Maps follow the same pattern (and also expose
<code>MapIteratorVisitor</code>), but each item instead uses <code>visit_visit_map_elt(first,
key, value)</code>.  Tuples, struct tuples, and tuple enum variants are all really
just named sequences. Likewise, structs and struct enum variants are just named
maps.</p>

<p>Because struct implementations are so common, here&rsquo;s an example how to do it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">Point</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">x</span><span class="o">:</span> <span class="kt">i32</span><span class="p">,</span>
</span><span class='line'>    <span class="n">y</span><span class="o">:</span> <span class="kt">i32</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">PointVisitor</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">state</span><span class="o">:</span> <span class="kt">u32</span><span class="p">,</span>
</span><span class='line'>    <span class="n">value</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="n">Point</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="n">MapVisitor</span> <span class="k">for</span> <span class="n">PointVisitor</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Visitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">V</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">match</span> <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="p">{</span>
</span><span class='line'>            <span class="mi">0</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="nb">Ok</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">visitor</span><span class="p">.</span><span class="n">visit_map_elt</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">x</span><span class="p">))))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="mi">1</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">state</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="nb">Ok</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">visitor</span><span class="p">.</span><span class="n">visit_map_elt</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">y</span><span class="p">))))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">_</span> <span class="o">=&gt;</span> <span class="nb">Ok</span><span class="p">(</span><span class="nb">None</span><span class="p">),</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">Serialize</span> <span class="k">for</span> <span class="n">Point</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Visitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">V</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">visit_named_map</span><span class="p">(</span><span class="s">&quot;Point&quot;</span><span class="p">,</span> <span class="n">PointVisitor</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">state</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>            <span class="n">value</span><span class="o">:</span> <span class="bp">self</span><span class="p">,</span>
</span><span class='line'>        <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Fortunately <code>serde2</code> also comes with a <code>#[derive_serialize]</code> macro so you don&rsquo;t
need to write this out by hand if you don&rsquo;t want to.</p>

<h3>Serializer</h3>

<p>Now to actually build a serializer. We start with a trait:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Serializer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Value</span><span class="p">;</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="n">where</span> <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s the responsibility of the serializer to create a visitor and then pass it
to the type. Oftentimes the serializer also implements <code>Visitor</code>, but it&rsquo;s not
required. Here&rsquo;s a snippet of the JSON serializer visitor:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">Visitor</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">W</span><span class="o">:</span> <span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">writer</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="k">mut</span> <span class="n">W</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">W</span><span class="o">:</span> <span class="nb">Writer</span><span class="o">&gt;</span> <span class="n">Visitor</span> <span class="k">for</span> <span class="n">Visitor</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">W</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Value</span> <span class="o">=</span> <span class="p">();</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Error</span> <span class="o">=</span> <span class="n">io</span><span class="o">::</span><span class="n">Error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_unit</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;null&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_bool</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">value</span> <span class="p">{</span>
</span><span class='line'>            <span class="bp">self</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;true&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="bp">self</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;false&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_isize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="n">isize</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">write</span><span class="o">!</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">writer</span><span class="p">,</span> <span class="s">&quot;{}&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_map</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="k">mut</span> <span class="n">visitor</span><span class="o">:</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="n">where</span> <span class="n">V</span><span class="o">:</span> <span class="n">ser</span><span class="o">::</span><span class="n">MapVisitor</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;{&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">while</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(())</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">visitor</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;}&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_map_elt</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="o">:</span> <span class="kt">bool</span><span class="p">,</span> <span class="n">key</span><span class="o">:</span> <span class="n">K</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="n">where</span> <span class="n">K</span><span class="o">:</span> <span class="n">ser</span><span class="o">::</span><span class="n">Serialize</span><span class="p">,</span>
</span><span class='line'>              <span class="n">V</span><span class="o">:</span> <span class="n">ser</span><span class="o">::</span><span class="n">Serialize</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">!</span><span class="n">first</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;,&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">));</span>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">writer</span><span class="p">.</span><span class="n">write_all</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;:&quot;</span><span class="p">));</span>
</span><span class='line'>        <span class="n">value</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hopefully it is pretty straight forward.</p>

<h2>Deserialization</h2>

<p>Now serialization is the easy part. Deserialization is where it always gets
more tricky. We follow a similar pattern as serialization. A deserializee
creates a visitor which accepts any type (most resulting in an error), and
passes it to a deserializer. This deserializer then extracts it&rsquo;s next value
from it&rsquo;s stream and passes it to the visitor, which then produces the actual
type.</p>

<p>It&rsquo;s achingly close to the same pattern between a serializer and a serializee,
but as hard as I tried, I couldn&rsquo;t unify the two. The error semantics are
different. In serialization, you want the serializer (which creates the
visitor) to define the error. In deserialization, you want the deserializer
which consumes the visitor to define the error.</p>

<p>Let&rsquo;s start first with <code>Error</code>. As opposed to serialization, when we&rsquo;re
deserializing we can error both in the <code>Deserializer</code> if there is a parse
error, or in the <code>Deserialize</code> if it&rsquo;s received an unexpected value. We do this
with an <code>Error</code> trait, which allows a deserializee to generically create the
few errors it needs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Error</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">syntax_error</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">end_of_stream_error</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">missing_field_error</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;static</span> <span class="kt">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the <code>Deserialize</code> trait, which looks similar to <code>Serialize</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Deserialize</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">deserialize</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">D</span><span class="o">:</span> <span class="n">Deserializer</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="n">deserializer</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">D</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>Visitor</code> also looks like the serialization <code>Visitor</code>, except for the
methods error by default.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Visitor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Value</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_bool</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">E</span><span class="o">:</span> <span class="n">Error</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_v</span><span class="o">:</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="o">::</span><span class="n">syntax_error</span><span class="p">())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_isize</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">E</span><span class="o">:</span> <span class="n">Error</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="n">isize</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">visit_i64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">i64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sequences and Maps are also a little different:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Visitor</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_seq</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">SeqVisitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_visitor</span><span class="o">:</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="o">::</span><span class="n">syntax_error</span><span class="p">())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_map</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">MapVisitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_visitor</span><span class="o">:</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="o">::</span><span class="n">syntax_error</span><span class="p">())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">SeqVisitor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Error</span><span class="o">:</span> <span class="n">Error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Deserialize</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">size_hint</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">usize</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">usize</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">MapVisitor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Error</span><span class="o">:</span> <span class="n">Error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">K</span><span class="o">:</span> <span class="n">Deserialize</span><span class="p">,</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Deserialize</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">visit_key</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Some</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">visit_value</span><span class="p">());</span>
</span><span class='line'>                <span class="nb">Ok</span><span class="p">(</span><span class="nb">Some</span><span class="p">((</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nb">None</span> <span class="o">=&gt;</span> <span class="nb">Ok</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_key</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">K</span><span class="o">:</span> <span class="n">Deserialize</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_value</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Deserialize</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">V</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">size_hint</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">usize</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">usize</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">None</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is an example struct deserializer. Structs are deserialized as a map, but
since maps are unordered, we need a simple state machine to extract the values.
In order to get the keys, we just create an enum for the fields, and a custom
deserializer to convert a string into a field without an allocation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">Point</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">x</span><span class="o">:</span> <span class="kt">i32</span><span class="p">,</span>
</span><span class='line'>    <span class="n">y</span><span class="o">:</span> <span class="kt">i32</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">Deserialize</span> <span class="k">for</span> <span class="n">Point</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">deserialize</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">D</span><span class="o">:</span> <span class="n">Deserializer</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="n">deserializer</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Point</span><span class="p">,</span> <span class="n">D</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">enum</span> <span class="n">Field</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">x</span><span class="p">,</span>
</span><span class='line'>            <span class="n">y</span><span class="p">,</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">struct</span> <span class="n">FieldVisitor</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">impl</span> <span class="n">Visitor</span> <span class="k">for</span> <span class="n">FieldVisitor</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">type</span> <span class="n">Value</span> <span class="o">=</span> <span class="n">Field</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">fn</span> <span class="n">visit_str</span><span class="o">&lt;</span>
</span><span class='line'>                <span class="n">E</span><span class="o">:</span> <span class="n">Error</span><span class="p">,</span>
</span><span class='line'>            <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Field</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">match</span> <span class="n">value</span> <span class="p">{</span>
</span><span class='line'>                    <span class="s">&quot;x&quot;</span> <span class="o">=&gt;</span> <span class="nb">Ok</span><span class="p">(</span><span class="n">Field</span><span class="o">::</span><span class="n">x</span><span class="p">),</span>
</span><span class='line'>                    <span class="s">&quot;y&quot;</span> <span class="o">=&gt;</span> <span class="nb">Ok</span><span class="p">(</span><span class="n">Field</span><span class="o">::</span><span class="n">y</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">_</span> <span class="o">=&gt;</span> <span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="o">::</span><span class="n">syntax_error</span><span class="p">()),</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">impl</span> <span class="n">Deserialize</span> <span class="k">for</span> <span class="n">Field</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">fn</span> <span class="n">deserialize</span><span class="o">&lt;</span>
</span><span class='line'>                <span class="n">D</span><span class="o">:</span> <span class="n">Deserializer</span><span class="p">,</span>
</span><span class='line'>            <span class="o">&gt;</span><span class="p">(</span><span class="n">state</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Field</span><span class="p">,</span> <span class="n">D</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">state</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">FieldVisitor</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">struct</span> <span class="n">Visitor</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">impl</span> <span class="n">Visitor</span> <span class="k">for</span> <span class="n">Visitor</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">type</span> <span class="n">Value</span> <span class="o">=</span> <span class="n">Point</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">fn</span> <span class="n">visit_map</span><span class="o">&lt;</span>
</span><span class='line'>                <span class="n">V</span><span class="o">:</span> <span class="n">MapVisitor</span><span class="p">,</span>
</span><span class='line'>            <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="k">mut</span> <span class="n">visitor</span><span class="o">:</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Point</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="p">{</span>
</span><span class='line'>                    <span class="kd">let</span> <span class="k">mut</span> <span class="n">x</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>                    <span class="kd">let</span> <span class="k">mut</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                    <span class="k">while</span> <span class="kd">let</span> <span class="nb">Some</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">visitor</span><span class="p">.</span><span class="n">visit_key</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">match</span> <span class="n">key</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">Field</span><span class="o">::</span><span class="n">x</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                                <span class="n">x</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">visitor</span><span class="p">.</span><span class="n">visit_value</span><span class="p">()));</span>
</span><span class='line'>                            <span class="p">}</span>
</span><span class='line'>                            <span class="n">Field</span><span class="o">::</span><span class="n">y</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                                <span class="n">y</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">visitor</span><span class="p">.</span><span class="n">visit_value</span><span class="p">()));</span>
</span><span class='line'>                            <span class="p">}</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                    <span class="kd">let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">match</span> <span class="n">x</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">x</span><span class="p">,</span>
</span><span class='line'>                        <span class="nb">None</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">return</span> <span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="o">::</span><span class="n">missing_field_error</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">));</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">};</span>
</span><span class='line'>                    <span class="kd">let</span> <span class="n">y</span> <span class="o">=</span> <span class="k">match</span> <span class="n">y</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nb">Some</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">y</span><span class="p">,</span>
</span><span class='line'>                        <span class="nb">None</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">return</span> <span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="o">::</span><span class="n">missing_field_error</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">));</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>                    <span class="nb">Ok</span><span class="p">(</span><span class="n">Point</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">x</span><span class="o">:</span> <span class="n">x</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">y</span><span class="o">:</span> <span class="n">y</span><span class="p">,</span>
</span><span class='line'>                    <span class="p">})</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">fn</span> <span class="n">visit_named_map</span><span class="o">&lt;</span>
</span><span class='line'>                <span class="n">V</span><span class="o">:</span> <span class="n">MapVisitor</span><span class="p">,</span>
</span><span class='line'>            <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Point</span><span class="p">,</span> <span class="n">V</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s">&quot;Point&quot;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="bp">self</span><span class="p">.</span><span class="n">visit_map</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="o">::</span><span class="n">syntax_error</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">deserializer</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">Visitor</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s a little more complicated, but once again there is
<code>#[derive_deserialize]</code>, which does all this work for you.</p>

<h3>Deserializer</h3>

<p>Deserializers then follow the same pattern as serializers. The one difference
is that we need to provide a special hook for <code>Option&lt;T&gt;</code> types so formats like
JSON can treat <code>null</code> types as options.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Deserializer</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="n">Error</span><span class="o">:</span> <span class="n">Error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Visitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">V</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c-Doc">/// The `visit_option` method allows a `Deserialize` type to inform the</span>
</span><span class='line'>    <span class="c-Doc">/// `Deserializer` that it&#39;s expecting an optional value. This allows</span>
</span><span class='line'>    <span class="c-Doc">/// deserializers that encode an optional value as a nullable value to</span>
</span><span class='line'>    <span class="c-Doc">/// convert the null value into a `None`, and a regular value as</span>
</span><span class='line'>    <span class="c-Doc">/// `Some(value)`.</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">visit_option</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Visitor</span><span class="p">,</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">visitor</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">V</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">V</span><span class="o">::</span><span class="n">Value</span><span class="p">,</span> <span class="n">Self</span><span class="o">::</span><span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">visit</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Performance</h2>

<p>So how does it perform? Here&rsquo;s the serialization benchmarks, with yet another
ordering. This time sorted by the performance:</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library                   </th>
<th> format                 </th>
<th> serialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> Rust     </td>
<td> capnproto-rust            </td>
<td> Cap&#8217;n Proto (unpacked) </td>
<td> 4226                 </td>
</tr>
<tr>
<td> Go       </td>
<td> go-capnproto              </td>
<td> Cap&#8217;n Proto            </td>
<td> 3824.20              </td>
</tr>
<tr>
<td> Rust     </td>
<td> bincode                   </td>
<td> Binary                 </td>
<td> 1020                 </td>
</tr>
<tr>
<td> Rust     </td>
<td> capnproto-rust            </td>
<td> Cap&#8217;n Proto (packed)   </td>
<td> 672                  </td>
</tr>
<tr>
<td> Go       </td>
<td> gogoprotobuf              </td>
<td> Protocol Buffers       </td>
<td> 596.78               </td>
</tr>
<tr>
<td> Rust     </td>
<td> rust-msgpack              </td>
<td> MessagePack            </td>
<td> 397                  </td>
</tr>
<tr>
<td> <strong>Rust</strong> </td>
<td> <strong>serde2::json</strong> (&amp;[u8])  </td>
<td> <strong>JSON</strong>               </td>
<td> <strong>373</strong>              </td>
</tr>
<tr>
<td> Rust     </td>
<td> rust-protobuf             </td>
<td> Protocol Buffers       </td>
<td> 357                  </td>
</tr>
<tr>
<td> C++      </td>
<td> rapidjson                 </td>
<td> JSON                   </td>
<td> 316                  </td>
</tr>
<tr>
<td> <strong>Rust</strong> </td>
<td> <strong>serde2::json</strong> (Custom) </td>
<td> <strong>JSON</strong>               </td>
<td> <strong>306</strong>              </td>
</tr>
<tr>
<td> <strong>Rust</strong> </td>
<td> <strong>serde2::json</strong> (Vec)    </td>
<td> <strong>JSON</strong>               </td>
<td> <strong>288</strong>              </td>
</tr>
<tr>
<td> Rust     </td>
<td> serde::json (Custom)      </td>
<td> JSON                   </td>
<td> 244                  </td>
</tr>
<tr>
<td> Rust     </td>
<td> serde::json (&amp;[u8])       </td>
<td> JSON                   </td>
<td> 222                  </td>
</tr>
<tr>
<td> Go       </td>
<td> goprotobuf                </td>
<td> Protocol Buffers       </td>
<td> 214.68               </td>
</tr>
<tr>
<td> Rust     </td>
<td> serde::json (Vec)         </td>
<td> JSON                   </td>
<td> 149                  </td>
</tr>
<tr>
<td> Go       </td>
<td> ffjson                    </td>
<td> JSON                   </td>
<td> 147.37               </td>
</tr>
<tr>
<td> Rust     </td>
<td> serialize::json           </td>
<td> JSON                   </td>
<td> 183                  </td>
</tr>
<tr>
<td> Go       </td>
<td> encoding/json             </td>
<td> JSON                   </td>
<td> 80.49                </td>
</tr>
</tbody>
</table>


<p>I think it&rsquo;s fair to say that on at least this benchmark we&rsquo;ve hit our
performance numbers. Writing to a preallocated buffer with <code>BufWriter</code> is 18%
<em>faster</em> than <a href="https://github.com/miloyip/rapidjson">rapidjson</a> (although to be
fair they are allocating). Our <code>Vec&lt;u8&gt;</code> writer comes in 12% slower. What&rsquo;s
interesting is this custom Writer. It turns out LLVM is still having trouble
lowering our generic <code>Vec::push_all</code> into a <code>memcpy</code>. This Writer variant
however is able to get us to rapidjson&rsquo;s level:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">push_all_bytes</span><span class="p">(</span><span class="n">dst</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">src</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">dst_len</span> <span class="o">=</span> <span class="n">dst</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">src_len</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">dst</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">src_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// we would have failed if `reserve` overflowed.</span>
</span><span class='line'>        <span class="n">dst</span><span class="p">.</span><span class="n">set_len</span><span class="p">(</span><span class="n">dst_len</span> <span class="o">+</span> <span class="n">src_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">ptr</span><span class="o">::</span><span class="n">copy_nonoverlapping_memory</span><span class="p">(</span>
</span><span class='line'>            <span class="n">dst</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">().</span><span class="n">offset</span><span class="p">(</span><span class="n">dst_len</span> <span class="k">as</span> <span class="n">isize</span><span class="p">),</span>
</span><span class='line'>            <span class="n">src</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">src_len</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">MyMemWriter1</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">buf</span><span class="o">:</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="nb">Writer</span> <span class="k">for</span> <span class="n">MyMemWriter1</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">write_all</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">push_all_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Deserialization we do much better than serde because we aren&rsquo;t passing around
all those tags, but we have a ways to catch up to rapidjson. Still, being just 37%
slower than the fastest JSON deserializer makes me feel pretty proud.</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library          </th>
<th> format                  </th>
<th> deserialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> Rust     </td>
<td> capnproto-rust   </td>
<td> Cap&#8217;n Proto (unpacked)  </td>
<td> 2123                   </td>
</tr>
<tr>
<td> Go       </td>
<td> go-capnproto     </td>
<td> Cap&#8217;n Proto (zero copy) </td>
<td> 1407.95                </td>
</tr>
<tr>
<td> Go       </td>
<td> go-capnproto     </td>
<td> Cap&#8217;n Proto             </td>
<td> 711.77                 </td>
</tr>
<tr>
<td> Rust     </td>
<td> capnproto-rust   </td>
<td> Cap&#8217;n Proto (packed)    </td>
<td> 529                    </td>
</tr>
<tr>
<td> Go       </td>
<td> gogoprotobuf     </td>
<td> Protocol Buffers        </td>
<td> 272.68                 </td>
</tr>
<tr>
<td> C++      </td>
<td> rapidjson        </td>
<td> JSON (sax)              </td>
<td> 189                    </td>
</tr>
<tr>
<td> C++      </td>
<td> rapidjson        </td>
<td> JSON (dom)              </td>
<td> 162                    </td>
</tr>
<tr>
<td> Rust     </td>
<td> bincode          </td>
<td> Binary                  </td>
<td> 142                    </td>
</tr>
<tr>
<td> Rust     </td>
<td> rust-protobuf    </td>
<td> Protocol Buffers        </td>
<td> 141                    </td>
</tr>
<tr>
<td> Rust     </td>
<td> rust-msgpack     </td>
<td> MessagePack             </td>
<td> 138                    </td>
</tr>
<tr>
<td> <strong>Rust</strong> </td>
<td> <strong>serde2::json</strong> </td>
<td> <strong>JSON</strong>                </td>
<td> <strong>122</strong>                </td>
</tr>
<tr>
<td> Go       </td>
<td> ffjson           </td>
<td> JSON                    </td>
<td> 95.06                  </td>
</tr>
<tr>
<td> Go       </td>
<td> goprotobuf       </td>
<td> Protocol Buffers        </td>
<td> 79.78                  </td>
</tr>
<tr>
<td> Rust     </td>
<td> serde::json      </td>
<td> JSON                    </td>
<td> 67                     </td>
</tr>
<tr>
<td> Rust     </td>
<td> serialize::json  </td>
<td> JSON                    </td>
<td> 25                     </td>
</tr>
<tr>
<td> Go       </td>
<td> encoding/json    </td>
<td> JSON                    </td>
<td> 22.79                  </td>
</tr>
</tbody>
</table>


<h2>Conclusion</h2>

<p>What a long trip it&rsquo;s been! I hope you enjoyed it. While there are still
a few things left to port over from serde1 to serde2 (like the JSON pretty
printer), and some things probably should be renamed, I&rsquo;m happy with the design
so I think it&rsquo;s in a place where people can start using it now. Please let me
know how it goes!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/09/syntex-syntex-extensions-for-rust-1-dot-0/">Syntex: Syntax Extensions for Rust 1.0</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-02-09T19:37:32-08:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>7:37 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I use and love syntax extensions, and I&rsquo;m planning on using them to simplify
down how one interacts with a system like
<a href="https://github.com/erickt/rust-serde">serde</a>. Unfortunately though, to write
them you need to use Rust&rsquo;s <code>libsyntax</code>, which is not going to be exposed in
Rust 1.0 because we&rsquo;re not ready to stablize it&rsquo;s API. That would really hamper
future development of the compiler.</p>

<p>It would be so nice though, writing this for every type we want to serialize:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[derive_deserialize]</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Point</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">x</span><span class="o">:</span> <span class="kt">int</span><span class="p">,</span>
</span><span class='line'>    <span class="n">y</span><span class="o">:</span> <span class="kt">int</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>instead of:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="o">&lt;</span><span class="n">D</span><span class="o">:</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">Point</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">deserialize_token</span><span class="p">(</span><span class="n">state</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">D</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Point</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">expect_struct_start</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;Point&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">x</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">loop</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">match</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">expect_struct_field_or_end</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">idx</span><span class="p">,</span>
</span><span class='line'>                <span class="nb">None</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">break</span> <span class="p">;</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">match</span> <span class="n">idx</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="mi">0</span><span class="k">u</span><span class="n">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">x</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">expect_struct_value</span><span class="p">()));</span> <span class="p">}</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="k">u</span><span class="n">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">y</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">expect_struct_value</span><span class="p">()));</span> <span class="p">}</span>
</span><span class='line'>                <span class="nb">None</span> <span class="o">|</span> <span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">panic</span><span class="o">!</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">match</span> <span class="n">x</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Some</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">x</span><span class="p">,</span>
</span><span class='line'>            <span class="nb">None</span> <span class="o">=&gt;</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">missing_field</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)),</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">y</span> <span class="o">=</span> <span class="k">match</span> <span class="n">y</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Some</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">y</span><span class="p">,</span>
</span><span class='line'>            <span class="nb">None</span> <span class="o">=&gt;</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">missing_field</span><span class="p">(</span><span class="s">&quot;y&quot;</span><span class="p">)),</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(</span><span class="n">Point</span><span class="p">{</span><span class="n">x</span><span class="o">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">:</span> <span class="n">y</span><span class="p">,})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So I want to announce my plan on how to deal with this (and also publically
announce that everyone can blame me if this turns out to hurt Rust&rsquo;s future
development). I&rsquo;ve started <a href="https://github.com/erickt/rust-syntex">syntex</a>, a
library that enables code generation using an unofficial tracking fork of
<code>libsyntax</code>. In order to deal with the fact that <code>libsyntax</code> might make
breaking changes between minor Rust releases, we will just release a minor or
major release of <code>syntex</code>, depending on if there were any breaking changes in
<code>libsyntax</code>.  Ideally <code>syntex</code> will allow the community to experiment with
different code generation approaches to see what would be worth merging
upstream. Or even better, what hooks are needed in the compiler so it doesn&rsquo;t
have to think about syntax extensions at all.</p>

<p>I&rsquo;ve got the basic version working right now. Here&rsquo;s a simple
<code>hello_world_macros</code> syntax extension (you can see the actual code
<a href="https://github.com/erickt/rust-syntex/tree/master/hello_world">here</a>).
First, the <code>hello_world_macros/Cargo.toml</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='toml'><span class='line'><span class="p">[</span><span class="n">package</span><span class="p">]</span>
</span><span class='line'><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hello_world_macros&quot;</span>
</span><span class='line'><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;0.2.0&quot;</span>
</span><span class='line'><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&quot;erick.tryzelaar@gmail.com&quot;</span> <span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">dependencies</span><span class="p">]</span>
</span><span class='line'><span class="n">syntex</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
</span><span class='line'><span class="n">syntex_syntax</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>syntex_syntax</code> is the crate for my fork of <code>libsyntax</code>, and <code>syntex</code>
provides some helper functions to ease registering syntax extensions.</p>

<p>Then the <code>src/lib.rs</code>, which declares a macro <code>hello_world</code> that just produces a
<code>"hello world"</code> string:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">extern</span> <span class="n">crate</span> <span class="n">syntex</span><span class="p">;</span>
</span><span class='line'><span class="k">extern</span> <span class="n">crate</span> <span class="n">syntex_syntax</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">use</span> <span class="n">syntex</span><span class="o">::</span><span class="n">Registry</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">use</span> <span class="n">syntex_syntax</span><span class="o">::</span><span class="n">ast</span><span class="o">::</span><span class="n">TokenTree</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">syntex_syntax</span><span class="o">::</span><span class="n">codemap</span><span class="o">::</span><span class="n">Span</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">syntex_syntax</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">base</span><span class="o">::</span><span class="p">{</span><span class="n">ExtCtxt</span><span class="p">,</span> <span class="n">MacExpr</span><span class="p">,</span> <span class="n">MacResult</span><span class="p">,</span> <span class="n">TTMacroExpander</span><span class="p">};</span>
</span><span class='line'><span class="kn">use</span> <span class="n">syntex_syntax</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">build</span><span class="o">::</span><span class="n">AstBuilder</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">syntex_syntax</span><span class="o">::</span><span class="n">parse</span><span class="o">::</span><span class="n">token</span><span class="o">::</span><span class="n">InternedString</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">expand_hello_world</span><span class="o">&lt;</span><span class="nl">&#39;cx</span><span class="o">&gt;</span><span class="p">(</span>
</span><span class='line'>    <span class="n">cx</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;cx</span> <span class="k">mut</span> <span class="n">ExtCtxt</span><span class="p">,</span>
</span><span class='line'>    <span class="n">sp</span><span class="o">:</span> <span class="n">Span</span><span class="p">,</span>
</span><span class='line'>    <span class="n">tts</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">TokenTree</span><span class="p">]</span>
</span><span class='line'><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Box</span><span class="o">&lt;</span><span class="n">MacResult</span> <span class="o">+</span> <span class="nl">&#39;cx</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">cx</span><span class="p">.</span><span class="n">expr_str</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">InternedString</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;hello world&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">MacExpr</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">fn</span> <span class="n">register</span><span class="p">(</span><span class="n">registry</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Registry</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">registry</span><span class="p">.</span><span class="n">register_fn</span><span class="p">(</span><span class="s">&quot;hello_world&quot;</span><span class="p">,</span> <span class="n">expand_hello_world</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now to use it. This is a little more complicated because we have to do code
generation, but Cargo helps with that. Our strategy is use a <code>build.rs</code> script
to do code generation in a <code>main.rss</code> file, and then use the <code>include!()</code> macro
to include it into our dummy <code>main.rs</code> file. Here&rsquo;s the <code>Cargo.toml</code> we need:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="p">[</span><span class="n">package</span><span class="p">]</span>
</span><span class='line'><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hello_world&quot;</span>
</span><span class='line'><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;0.2.0&quot;</span>
</span><span class='line'><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&quot;erick.tryzelaar@gmail.com&quot;</span> <span class="p">]</span>
</span><span class='line'><span class="n">build</span> <span class="o">=</span> <span class="s">&quot;build.rs&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">build</span><span class="o">-</span><span class="n">dependencies</span><span class="p">]</span>
</span><span class='line'><span class="n">syntex</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
</span><span class='line'><span class="n">syntex_syntax</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="n">build</span><span class="o">-</span><span class="n">dependencies</span><span class="p">.</span><span class="n">hello_world_macros</span><span class="p">]</span>
</span><span class='line'><span class="n">path</span> <span class="o">=</span> <span class="s">&quot;hello_world_macros&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s the <code>build.rs</code>, which actually performs the code generation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">extern</span> <span class="n">crate</span> <span class="n">syntex</span><span class="p">;</span>
</span><span class='line'><span class="k">extern</span> <span class="n">crate</span> <span class="n">hello_world_macros</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">os</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">syntex</span><span class="o">::</span><span class="n">Registry</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>    <span class="n">hello_world_macros</span><span class="o">::</span><span class="n">register</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">registry</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">registry</span><span class="p">.</span><span class="n">expand</span><span class="p">(</span>
</span><span class='line'>        <span class="s">&quot;hello_world&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="nb">Path</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;src/main.rss&quot;</span><span class="p">),</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="nb">Path</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">os</span><span class="o">::</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;OUT_DIR&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;main.rs&quot;</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our <code>main.rs</code> driver script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="c1">// Include the real main</span>
</span><span class='line'><span class="n">include</span><span class="o">!</span><span class="p">(</span><span class="n">concat</span><span class="o">!</span><span class="p">(</span><span class="n">env</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;OUT_DIR&quot;</span><span class="p">),</span> <span class="s">&quot;/main.rs&quot;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally the <code>main.rss</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">hello_world</span><span class="o">!</span><span class="p">();</span>
</span><span class='line'>    <span class="nb">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>One limitiation you can see above is that we unfortunately can&rsquo;t compose our
macros with the Rust macros is that <code>syntex</code> currently has no awareness of the
Rust macros, and since macros are parsed outside-in, we have to leave the
tokens inside a macro like <code>println!()</code> untouched.</p>

<hr />

<p>That&rsquo;s <code>syntex</code>. There is a bunch of more work left to be done in <code>syntex</code>
to make it really useable. There&rsquo;s also a lot of work in Rust and Cargo that
would help it be really effective:</p>

<ul>
<li>We need a way to inform Rust that this block of code is actually coming from
a different file than the one it&rsquo;s processing. This is roughly equivalent to
  the <a href="https://gcc.gnu.org/onlinedocs/cpp/Line-Control.html">#line</a> macros in
<code>C</code>.</li>
<li>We could upstream the &ldquo;ignore unknown macros&rdquo; patch to minimize
changes to <code>libsyntax</code>.</li>
<li>It would be nice if we could allow <code>#[path]</code> to reference an environment
variable. This would be a little cleaner than using <code>include!(...)</code>.</li>
<li>We need a way to extract macros from a crate.</li>
</ul>


<p>On Cargo&rsquo;s side:</p>

<ul>
<li>It would be nice if Cargo could be told to use a generated file as the
<code>main.rs</code>/<code>lib.rs</code>/etc.</li>
<li><code>Cargo.toml</code> could grow a plugin mechanism to remove the need to write a
<code>build.rs</code> script.</li>
</ul>


<p>I&rsquo;m sure there&rsquo;s plenty more that needs to get done! So, please help out!</p>

<p>edit: comments on <a href="https://www.reddit.com/r/rust/comments/2vdzd1/syntex_syntax_extensions_for_rust_10/">reddit</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/13/performance-digression/">Rewriting Rust Serialization, Part 3.1: Another Performance Digression</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-13T18:35:08-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>6:35 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Wow, home stretch! Here&rsquo;s the rest of the series if you want to catch up:
<a href="http://erickt.github.io/blog/2014/10/28/serialization/">part 1</a>,
<a href="http://erickt.github.io/blog/2014/11/03/performance/">part 2</a>,
<a href="http://erickt.github.io/blog/2014/11/03/performance/">part 2.1</a>,
<a href="http://erickt.github.io/blog/2014/11/03/performance/">part 2.2</a>, and
<a href="http://erickt.github.io/blog/2014/12/13/rewriting-rust-serialization/">part 3</a>.</p>

<p>Overall <code>serde</code>&rsquo;s approach for serialization works out pretty well. One thing I
forgot to include in the last post was that I also have two benchmarks that are
not using <code>serde</code>, but are just safely reading and writing values.  Assuming I
haven&rsquo;t missed anything, they should be the upper limit in performance we can
get out of any serialization framework: Here&rsquo;s
<a href="https://github.com/erickt/rust-serde/blob/master/benches/bench_log.rs#L1021">serialization</a>:</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library                        </th>
<th> serialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> <strong>rust</strong> </td>
<td> <strong>max without string escapes</strong> </td>
<td> <strong>353</strong>              </td>
</tr>
<tr>
<td> c++      </td>
<td> rapidjson                      </td>
<td> 304                  </td>
</tr>
<tr>
<td> <strong>rust</strong> </td>
<td> <strong>max with string escape</strong>     </td>
<td> <strong>234</strong>              </td>
</tr>
<tr>
<td> rust     </td>
<td> serde::json                    </td>
<td> 201                  </td>
</tr>
<tr>
<td> rust     </td>
<td> serialize::json                </td>
<td> 147                  </td>
</tr>
<tr>
<td> go       </td>
<td> ffjson                         </td>
<td> 147                  </td>
</tr>
</tbody>
</table>


<p>So beyond optimizing string escaping, <code>serde::json</code> is only 14% slower than the
zero-cost version and 34% slower than <code>rapidjson</code>.</p>

<p><a href="https://github.com/erickt/rust-serde/blob/master/benches/bench_log.rs#L1613">Deserialization</a>,
on the other hand, still has a ways to go:</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library                         </th>
<th> deserialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> rust     </td>
<td> rapidjson (SAX)                 </td>
<td> 189                    </td>
</tr>
<tr>
<td> c++      </td>
<td> rapidjson (DOM)                 </td>
<td> 162                    </td>
</tr>
<tr>
<td> <strong>rust</strong> </td>
<td> <strong>max with Iterator&lt;u8&gt;</strong> </td>
<td> <strong>152</strong>                </td>
</tr>
<tr>
<td> go       </td>
<td> ffjson                          </td>
<td> 95                     </td>
</tr>
<tr>
<td> <strong>rust</strong> </td>
<td> <strong>max with Reader</strong>             </td>
<td> <strong>78</strong>                 </td>
</tr>
<tr>
<td> rust     </td>
<td> serde::json                     </td>
<td> 73                     </td>
</tr>
<tr>
<td> rust     </td>
<td> serialize::json                 </td>
<td> 24                     </td>
</tr>
</tbody>
</table>


<p>There are a couple interesting things here:</p>

<p>First, <code>serde::json</code> is built upon consuming from an <code>Iterator&lt;u8&gt;</code>, so we&rsquo;re
48% slower than our theoretical max, and 58% slower than <code>rapidjson</code>. It looks
like tagged tokens, while faster than the closures in <code>libserialize</code>, are still
pretty expensive.</p>

<p>Second, <code>ffjson</code> is beating us and they compile dramatically faster too. The
<a href="https://github.com/cloudflare/goser">goser</a> test suite takes about 0.54
seconds to compile, whereas mine takes about 30 seconds at <code>--opt-level=3</code>
(!!). Rust itself is only taking 1.5 seconds, the rest is spent in LLVM. With
no optimization, it compiles &ldquo;only&rdquo; in 5.6 seconds, and is 96% slower.</p>

<p>Third, <code>Reader</code> is a surprisingly expensive trait when dealing with a format
like JSON that need to read a byte at a time. It turns out we&rsquo;re not
<a href="https://github.com/rust-lang/rust/issues/19864">generating great code</a> for
types with padding. aatch has been working on fixing this though.</p>

<hr />

<p>Since I wrote that last section, I did a little more experimentation to try to
figure out why our serialization upper bound is 23% slower than rapidjson. And,
well, maybe I found it?</p>

<table>
<thead>
<tr>
<th>                                </th>
<th> serialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> serde::json with a MyMemWriter </td>
<td> 346                  </td>
</tr>
<tr>
<td> serde::json with a Vec<u8>     </td>
<td> 247                  </td>
</tr>
</tbody>
</table>


<p>All I did with <code>MyMemWriter</code> is copy the <code>Vec::&lt;u8&gt;</code> implementation of <code>Writer</code>
into the local codebase:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">MyMemWriter0</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">buf</span><span class="o">:</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">MyMemWriter0</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">with_capacity</span><span class="p">(</span><span class="n">cap</span><span class="o">:</span> <span class="kt">uint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyMemWriter0</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">MyMemWriter0</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">buf</span><span class="o">:</span> <span class="n">Vec</span><span class="o">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="nb">Writer</span> <span class="k">for</span> <span class="n">MyMemWriter0</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">io</span><span class="o">::</span><span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">push_all</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#[bench]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">bench_serializer_my_mem_writer0</span><span class="p">(</span><span class="n">b</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Bencher</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">log</span> <span class="o">=</span> <span class="n">Log</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">json</span> <span class="o">=</span> <span class="n">json</span><span class="o">::</span><span class="n">to_vec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">log</span><span class="p">);</span>
</span><span class='line'>    <span class="n">b</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">wr</span> <span class="o">=</span> <span class="n">MyMemWriter0</span><span class="o">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">wr</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">serializer</span> <span class="o">=</span> <span class="n">json</span><span class="o">::</span><span class="n">Serializer</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">wr</span><span class="p">.</span><span class="n">by_ref</span><span class="p">());</span>
</span><span class='line'>        <span class="n">log</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">serializer</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">_json</span> <span class="o">=</span> <span class="n">serializer</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#[bench]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">bench_serializer_vec</span><span class="p">(</span><span class="n">b</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Bencher</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">log</span> <span class="o">=</span> <span class="n">Log</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">json</span> <span class="o">=</span> <span class="n">json</span><span class="o">::</span><span class="n">to_vec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">log</span><span class="p">);</span>
</span><span class='line'>    <span class="n">b</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">wr</span> <span class="o">=</span> <span class="n">Vec</span><span class="o">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">wr</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">serializer</span> <span class="o">=</span> <span class="n">json</span><span class="o">::</span><span class="n">Serializer</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">wr</span><span class="p">.</span><span class="n">by_ref</span><span class="p">());</span>
</span><span class='line'>        <span class="n">log</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">serializer</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">_json</span> <span class="o">=</span> <span class="n">serializer</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Somehow it&rsquo;s not enough to just mark <code>Vec::write</code> as
<code>#[inline]</code>, having it in the same file gave LLVM enough information to
optimize it&rsquo;s overhead away. Even using <code>#[inline(always)]</code> on <code>Vec::write</code> and
<code>Vec::push_all</code> isn&rsquo;t able to get the same increase, so I&rsquo;m not sure how to
replicate this in the general case.</p>

<p>Also interesting is <code>bench_serializer_slice</code>, which uses <code>BufWriter</code>.</p>

<table>
<thead>
<tr>
<th>                                </th>
<th> serialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> serde::json with a BufWriter   </td>
<td> 342                  </td>
</tr>
</tbody>
</table>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[bench]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">bench_serializer_slice</span><span class="p">(</span><span class="n">b</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">Bencher</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">log</span> <span class="o">=</span> <span class="n">Log</span><span class="o">::</span><span class="n">new</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">json</span> <span class="o">=</span> <span class="n">json</span><span class="o">::</span><span class="n">to_vec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">log</span><span class="p">);</span>
</span><span class='line'>    <span class="n">b</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">..</span> <span class="mi">1024</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">buf</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">(){</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">wr</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">BufWriter</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">serializer</span> <span class="o">=</span> <span class="n">json</span><span class="o">::</span><span class="n">Serializer</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="n">wr</span><span class="p">.</span><span class="n">by_ref</span><span class="p">());</span>
</span><span class='line'>        <span class="n">log</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">serializer</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">_json</span> <span class="o">=</span> <span class="n">serializer</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<hr />

<p>Another digression. Since I wrote the above, aatch has put out some PRs that
should help speed up enums.
<a href="https://github.com/rust-lang/rust/pull/19898">19898</a> and
<a href="https://github.com/rust-lang/rust/pull/20060">#20060</a> and was able to optimize
the padding out of enums and fix an issue with returns generating bad code. In
my <a href="https://github.com/rust-lang/rust/issues/19864">bug from earlier</a>
his patches were able to speed up my benchmark returning an
<code>Result&lt;(), IoError&gt;</code> from running at 40MB/s to 88MB/s. However, if we&rsquo;re able
to reduce <code>IoError</code> down to a word, we get the performance up to 730MB/s! We
also might get enum compression, so a type like <code>Result&lt;(), IoError&gt;</code> then
would speed up to 1200MB/s! I think going in this direction is going to really
help speed things up.</p>

<hr />

<p>That was taking a while, so until next time!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/13/rewriting-rust-serialization/">Rewriting Rust Serialization, Part 3: Introducing Serde</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-13T14:40:18-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:40 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There&rsquo;s been a long digression over the past month
(<a href="http://erickt.github.io/blog/2014/11/19/adventures-in-debugging-a-potential-osx-kernel-bug/">possible kernel bugs</a>,
<a href="http://erickt.github.io/blog/2014/11/22/benchmarking-is-confusing/">benchmarking Writers</a>,
and
<a href="https://github.com/rust-lang/rust/pull/19574">don&rsquo;t believe in magic, folks</a>), but I&rsquo;m back
into serialization. Woo! Here&rsquo;s
<a href="http://erickt.github.io/blog/2014/10/28/serialization/">part 1</a>
<a href="http://erickt.github.io/blog/2014/11/03/performance/">part 2</a>,
<a href="http://erickt.github.io/blog/2014/11/03/performance/">part 2.1</a>, and
<a href="http://erickt.github.io/blog/2014/11/03/performance/">part 2.2</a> if you need
to catch up.</p>

<p>So <code>libserialize</code> has some pretty serious downsides. It&rsquo;s slow, it&rsquo;s got this
weird recursive closure thing going on, and it can&rsquo;t even represent enum types
like a <code>serialize::json::Json</code>. We need a new solution, and while I was at it,
we ended up with two: <a href="https://github.com/erickt/rust-serde">serde</a> and
<a href="https://github.com/erickt/rust-serde/tree/master/serde2">serde2</a>. Both are
different approaches to trying to address these problems. The biggest one being
the type representation problem.</p>

<h2>Serde Version 1</h2>

<h3>Deserialization</h3>

<p>I want to start with deserialization first, as that&rsquo;s really the interesting
bit. To repeat myself a little bit from
<a href="https://erickt.github.io/blog/2014/10/28/serialization/">part 1</a>,
here is a generic json <code>Value</code> enum:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">enum</span> <span class="n">Value</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">I64</span><span class="p">(</span><span class="kt">i64</span><span class="p">),</span>
</span><span class='line'>    <span class="n">U64</span><span class="p">(</span><span class="kt">u64</span><span class="p">),</span>
</span><span class='line'>    <span class="n">F64</span><span class="p">(</span><span class="kt">f64</span><span class="p">),</span>
</span><span class='line'>    <span class="n">String</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
</span><span class='line'>    <span class="n">Boolean</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span>
</span><span class='line'>    <span class="n">Array</span><span class="p">(</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span><span class="p">),</span>
</span><span class='line'>    <span class="n">Object</span><span class="p">(</span><span class="n">TreeMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Value</span><span class="o">&gt;</span><span class="p">),</span>
</span><span class='line'>    <span class="n">Null</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To deserialize a string like <code>[1, true]</code> into
<code>Array(vec![I64(1), Boolean(true)])</code>, we need to peek at one character ahead
(ignoring whitespace) in order to discover what is the type of the next value.
We then can use that knowledge to pick the right variant, and parse the next
value correctly. While I haven&rsquo;t formally studied this stuff, I believe this
can be more formally stated as <code>Value</code> requires at least a LL(1) grammar,
but since <code>libserialize</code> supports no lookahead, so at most it can handle LL(0)
grammars.</p>

<p>Since I was thinking of this problem in terms of grammars, I wanted to take a
page out of their book and implement generic deserialization in this style.
<code>serde::de::Deserializer</code>s are then an <code>Iterator&lt;serde::de::Token&gt;</code> lexer that
produces a token stream, and <code>serde::de::Deserialize</code>s are a parser that
consumes this stream to produce a value. Here&rsquo;s <code>serde::de::Token</code>, which can
represent nearly all the rust types:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">enum</span> <span class="n">Token</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Null</span><span class="p">,</span>
</span><span class='line'>    <span class="nb">Bool</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span>
</span><span class='line'>    <span class="nb">Int</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
</span><span class='line'>    <span class="n">I8</span><span class="p">(</span><span class="kt">i8</span><span class="p">),</span>
</span><span class='line'>    <span class="n">I16</span><span class="p">(</span><span class="kt">i16</span><span class="p">),</span>
</span><span class='line'>    <span class="n">I32</span><span class="p">(</span><span class="kt">i32</span><span class="p">),</span>
</span><span class='line'>    <span class="n">I64</span><span class="p">(</span><span class="kt">i64</span><span class="p">),</span>
</span><span class='line'>    <span class="n">Uint</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span>
</span><span class='line'>    <span class="n">U8</span><span class="p">(</span><span class="kt">u8</span><span class="p">),</span>
</span><span class='line'>    <span class="n">U16</span><span class="p">(</span><span class="kt">u16</span><span class="p">),</span>
</span><span class='line'>    <span class="n">U32</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span>
</span><span class='line'>    <span class="n">U64</span><span class="p">(</span><span class="kt">u64</span><span class="p">),</span>
</span><span class='line'>    <span class="n">F32</span><span class="p">(</span><span class="kt">f32</span><span class="p">),</span>
</span><span class='line'>    <span class="n">F64</span><span class="p">(</span><span class="kt">f64</span><span class="p">),</span>
</span><span class='line'>    <span class="nb">Char</span><span class="p">(</span><span class="n">char</span><span class="p">),</span>
</span><span class='line'>    <span class="nb">Str</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;static</span> <span class="kt">str</span><span class="p">),</span>
</span><span class='line'>    <span class="n">String</span><span class="p">(</span><span class="n">String</span><span class="p">),</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">Option</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span>     <span class="c1">// true if the option has a value</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">TupleStart</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="c1">// estimate of the number of values</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StructStart</span><span class="p">(</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="kt">str</span><span class="p">,</span> <span class="c1">// the struct name</span>
</span><span class='line'>        <span class="kt">uint</span><span class="p">,</span>         <span class="c1">// estimate of the number of (string, value) pairs</span>
</span><span class='line'>    <span class="p">),</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">EnumStart</span><span class="p">(</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="kt">str</span><span class="p">,</span> <span class="c1">// the enum name</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="kt">str</span><span class="p">,</span> <span class="c1">// the variant name</span>
</span><span class='line'>        <span class="kt">uint</span>          <span class="c1">// estimate of the number of values</span>
</span><span class='line'>    <span class="p">),</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">SeqStart</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="c1">// number of values</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">MapStart</span><span class="p">(</span><span class="kt">uint</span><span class="p">),</span> <span class="c1">// number of (value, value) pairs</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">End</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>serde::de::Deserialize</code> stream must generate tokens that follow this
grammar:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='antlr'><span class='line'><span class="nl">value</span><span class="w"> </span><span class="p">::</span><span class="o">=</span><span class="w"> </span><span class="no">Null</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="no">Bool</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="no">Int</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="o">...</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nv">option</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nv">tuple</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nv">struct</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nv">enum</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nv">sequence</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="nv">map</span><span class="w"></span>
</span><span class='line'><span class="w">        </span><span class="p">;</span><span class="w"></span>
</span><span class='line'>
</span><span class='line'><span class="nl">option</span><span class="w"> </span><span class="p">::</span><span class="o">=</span><span class="w"> </span><span class="no">Option</span><span class="w"> </span><span class="nv">value</span><span class="w"></span>
</span><span class='line'><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="no">Option</span><span class="w"></span>
</span><span class='line'><span class="w">         </span><span class="p">;</span><span class="w"></span>
</span><span class='line'>
</span><span class='line'><span class="nl">tuple</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">TupleStart</span><span class="w"> </span><span class="nv">value</span><span class="o">*</span><span class="w"> </span><span class="no">End</span><span class="p">;</span><span class="w"></span>
</span><span class='line'>
</span><span class='line'><span class="nl">struct</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">StructStart</span><span class="w"> </span><span class="o">(</span><span class="no">Str</span><span class="w"> </span><span class="nv">value</span><span class="o">)*</span><span class="w"> </span><span class="no">End</span><span class="p">;</span><span class="w"></span>
</span><span class='line'>
</span><span class='line'><span class="nl">enum</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">EnumStart</span><span class="w"> </span><span class="nv">value</span><span class="o">*</span><span class="w"> </span><span class="no">End</span><span class="p">;</span><span class="w"></span>
</span><span class='line'>
</span><span class='line'><span class="nl">sequence</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">SeqStart</span><span class="w"> </span><span class="nv">value</span><span class="o">*</span><span class="w"> </span><span class="no">End</span><span class="p">;</span><span class="w"></span>
</span><span class='line'>
</span><span class='line'><span class="nl">map</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">MapStart</span><span class="w"> </span><span class="o">(</span><span class="nv">value</span><span class="w"> </span><span class="nv">value</span><span class="o">)*</span><span class="w"> </span><span class="no">End</span><span class="p">;</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure>


<p>For performance reasons, there is no separator in the compound grammar.</p>

<p>Finishing up this section are the actual traits, <code>Deserialize</code> and <code>Deserializer</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">D</span><span class="o">:</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">d</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">D</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">token</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">expect_token</span><span class="p">());</span>
</span><span class='line'>        <span class="n">Deserialize</span><span class="o">::</span><span class="n">deserialize_token</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">deserialize_token</span><span class="p">(</span><span class="n">d</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">D</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Token</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="c-Doc">/// Called when a `Deserialize` expected more tokens, but the</span>
</span><span class='line'>    <span class="c-Doc">/// `Deserializer` was empty.</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">end_of_stream_error</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c-Doc">/// Called when a `Deserializer` was unable to properly parse the stream.</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">syntax_error</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">,</span> <span class="n">expected</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="p">[</span><span class="n">TokenKind</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c-Doc">/// Called when a named structure or enum got a name that it didn&#39;t expect.</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">unexpected_name_error</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c-Doc">/// Called when a value was unable to be coerced into another value.</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">conversion_error</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">E</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c-Doc">/// Called when a `Deserialize` structure did not deserialize a field</span>
</span><span class='line'>    <span class="c-Doc">/// named `field`.</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">missing_field</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="kt">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c-Doc">/// Called when a `Deserialize` has decided to not consume this token.</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">ignore_field</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">_</span><span class="o">:</span> <span class="n">IgnoreTokens</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">Deserialize</span><span class="o">::</span><span class="n">deserialize</span><span class="p">(</span><span class="bp">self</span><span class="p">));</span>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">expect_token</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Token</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">||</span> <span class="nb">Err</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">end_of_stream_error</span><span class="p">()))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>Deserialize</code> trait is kept pretty slim, and is how lookahead is
implemented. <code>Deserializer</code> is an enhanced <code>Iterator&lt;Result&lt;Token, E&gt;&gt;</code>, with
many helpful default methods. Here are them in action. First we&rsquo;ll start with
what&rsquo;s probably the simplest <code>Deserializer</code>, which just wraps a <code>Vec&lt;Token&gt;</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">enum</span> <span class="n">Error</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">EndOfStream</span><span class="p">,</span>
</span><span class='line'>    <span class="n">SyntaxError</span><span class="p">(</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">TokenKind</span><span class="o">&gt;</span><span class="p">),</span>
</span><span class='line'>    <span class="n">UnexpectedName</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ConversionError</span><span class="p">,</span>
</span><span class='line'>    <span class="n">MissingField</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;static</span> <span class="kt">str</span><span class="p">),</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">TokenDeserializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">tokens</span><span class="o">:</span> <span class="n">Iter</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;&gt;</span> <span class="n">TokenDeserializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">new</span><span class="p">(</span><span class="n">tokens</span><span class="o">:</span> <span class="n">Iter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TokenDeserializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">TokenDeserializer</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">,</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;&gt;</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Token</span><span class="p">,</span> <span class="n">Error</span><span class="o">&gt;&gt;</span> <span class="k">for</span> <span class="n">TokenDeserializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">option</span><span class="o">::</span><span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Token</span><span class="p">,</span> <span class="n">Error</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">tokens</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">token</span><span class="o">|</span> <span class="nb">Ok</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&gt;&gt;</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">Error</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">TokenDeserializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">end_of_stream_error</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Error</span><span class="o">::</span><span class="n">EndOfStream</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">syntax_error</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_token</span><span class="o">:</span> <span class="n">Token</span><span class="p">,</span> <span class="n">expected</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">TokenKind</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Error</span><span class="o">::</span><span class="n">SyntaxError</span><span class="p">(</span><span class="n">expected</span><span class="p">.</span><span class="n">to_vec</span><span class="p">())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">unexpected_name_error</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Error</span><span class="o">::</span><span class="n">UnexpectedName</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">conversion_error</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">_token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Error</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Error</span><span class="o">::</span><span class="n">ConversionError</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">missing_field</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">TokenDeserializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Error</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="kt">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">Err</span><span class="p">(</span><span class="n">Error</span><span class="o">::</span><span class="n">MissingField</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Overall it should be pretty straight forward. As usual, error handling makes
things a bit noisier, but hopefully it&rsquo;s not too onerous. Next is a
<code>Deserialize</code> for <code>bool</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">D</span><span class="o">:</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="k">for</span> <span class="kt">bool</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">deserialize_token</span><span class="p">(</span><span class="n">d</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">D</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">d</span><span class="p">.</span><span class="n">expect_bool</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Token</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">expect_bool</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">token</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Token</span><span class="o">::</span><span class="nb">Bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Ok</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
</span><span class='line'>            <span class="n">token</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">static</span> <span class="n">EXPECTED_TOKENS</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="p">[</span><span class="n">TokenKind</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">[</span>
</span><span class='line'>                    <span class="n">TokenKind</span><span class="o">::</span><span class="n">BoolKind</span><span class="p">,</span>
</span><span class='line'>                <span class="p">];</span>
</span><span class='line'>                <span class="nb">Err</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">syntax_error</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">EXPECTED_TOKENS</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Simple! Sequences are a bit more tricky. Here&rsquo;s <code>Deserialize</code> a <code>Vec&lt;T&gt;</code>. We
use a helper adaptor <code>SeqDeserializer</code> to deserialize from all types that
implement <code>FromIterator</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span>
</span><span class='line'>    <span class="n">D</span><span class="o">:</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">E</span><span class="p">,</span>
</span><span class='line'>    <span class="n">T</span><span class="o">:</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">D</span> <span class="p">,</span><span class="n">E</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">deserialize_token</span><span class="p">(</span><span class="n">d</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">D</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">d</span><span class="p">.</span><span class="n">expect_seq</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Token</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">expect_seq</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">C</span><span class="o">:</span> <span class="nb">FromIterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">C</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">expect_seq_start</span><span class="p">(</span><span class="n">token</span><span class="p">));</span>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">err</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">collection</span><span class="o">:</span> <span class="n">C</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">d</span> <span class="o">=</span> <span class="n">SeqDeserializer</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">d</span><span class="o">:</span> <span class="bp">self</span><span class="p">,</span>
</span><span class='line'>                <span class="n">len</span><span class="o">:</span> <span class="n">len</span><span class="p">,</span>
</span><span class='line'>                <span class="n">err</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">err</span><span class="p">,</span>
</span><span class='line'>            <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">d</span><span class="p">.</span><span class="n">collect</span><span class="p">()</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">match</span> <span class="n">err</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Some</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">),</span>
</span><span class='line'>            <span class="nb">None</span> <span class="o">=&gt;</span> <span class="nb">Ok</span><span class="p">(</span><span class="n">collection</span><span class="p">),</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">SeqDeserializer</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">D</span><span class="o">:</span> <span class="nl">&#39;a</span><span class="p">,</span> <span class="n">E</span><span class="o">:</span> <span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">d</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="k">mut</span> <span class="n">D</span><span class="p">,</span>
</span><span class='line'>    <span class="n">len</span><span class="o">:</span> <span class="kt">uint</span><span class="p">,</span>
</span><span class='line'>    <span class="n">err</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="k">mut</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span>
</span><span class='line'>    <span class="nl">&#39;a</span><span class="p">,</span>
</span><span class='line'>    <span class="n">D</span><span class="o">:</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">E</span><span class="p">,</span>
</span><span class='line'>    <span class="n">T</span><span class="o">:</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&gt;</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">SeqDeserializer</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">option</span><span class="o">::</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">match</span> <span class="bp">self</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">expect_seq_elt_or_end</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Ok</span><span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>                <span class="n">next</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="o">*</span><span class="bp">self</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
</span><span class='line'>                <span class="nb">None</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">size_hint</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">uint</span><span class="p">,</span> <span class="n">option</span><span class="o">::</span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">uint</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="nb">Some</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Last is a struct deserializer. This relies on a simple state machine in order
to deserialize from out of order maps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">a</span><span class="o">:</span> <span class="p">(),</span>
</span><span class='line'>    <span class="n">b</span><span class="o">:</span> <span class="kt">uint</span><span class="p">,</span>
</span><span class='line'>    <span class="n">c</span><span class="o">:</span> <span class="n">TreeMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">char</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span>
</span><span class='line'>    <span class="n">D</span><span class="o">:</span> <span class="n">Deserializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">E</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">Deserialize</span><span class="o">&lt;</span><span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">deserialize_token</span><span class="p">(</span><span class="n">d</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">D</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Foo</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">expect_struct_start</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s">&quot;Foo&quot;</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">a</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">static</span> <span class="n">FIELDS</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;static</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">&#39;static</span> <span class="kt">str</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">[</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">loop</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">match</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">expect_struct_field_or_end</span><span class="p">(</span><span class="n">FIELDS</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">idx</span><span class="p">,</span>
</span><span class='line'>                <span class="nb">None</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="k">break</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">match</span> <span class="n">idx</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">a</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">expect_struct_value</span><span class="p">()));</span> <span class="p">}</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">expect_struct_value</span><span class="p">()));</span> <span class="p">}</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="n">c</span> <span class="o">=</span> <span class="nb">Some</span><span class="p">(</span><span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">expect_struct_value</span><span class="p">()));</span> <span class="p">}</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">unreachable</span><span class="o">!</span><span class="p">(),</span>
</span><span class='line'>                <span class="nb">None</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="kd">let</span> <span class="n">_</span><span class="o">:</span> <span class="n">IgnoreTokens</span> <span class="o">=</span> <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">Deserialize</span><span class="o">::</span><span class="n">deserialize</span><span class="p">(</span><span class="n">d</span><span class="p">));</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(</span><span class="n">Foo</span> <span class="p">{</span> <span class="n">a</span><span class="o">:</span> <span class="n">a</span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span> <span class="n">b</span><span class="o">:</span> <span class="n">b</span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span> <span class="n">c</span><span class="o">:</span> <span class="n">c</span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span> <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s more complicated than <code>libserialize</code>&rsquo;s struct parsing, but it performs
much better because it can handle out of order maps without buffering tokens.</p>

<h3>Serialization</h3>

<p>Serialization&rsquo;s story is a much simpler one. Conceptually
<code>serde::ser::Serializer</code>/<code>serde::ser::Serialize</code> are inspired by the
deserialization story, but we don&rsquo;t need the tagged tokens because we already
know the types. Here are the traits:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">S</span><span class="o">:</span> <span class="n">Serializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Serializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_null</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_bool</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_int</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize_i64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">i64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_i8</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">i8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize_i64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">i64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_i16</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">i16</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize_i64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">i64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_i32</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">i32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize_i64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">i64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_i64</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">i64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_uint</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">uint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize_u64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_u8</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">u8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize_u64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_u16</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">u16</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize_u64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">u32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize_u64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">u64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_u64</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">u64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_f32</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">f32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize_f64</span><span class="p">(</span><span class="n">v</span> <span class="k">as</span> <span class="kt">f64</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_f64</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">f64</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_char</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="n">char</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_str</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_tuple_start</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">len</span><span class="o">:</span> <span class="kt">uint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_tuple_elt</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_tuple_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_struct_start</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span><span class="p">,</span> <span class="n">len</span><span class="o">:</span> <span class="kt">uint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_struct_elt</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_struct_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_enum_start</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span><span class="p">,</span> <span class="n">variant</span><span class="o">:</span> <span class="o">&amp;</span><span class="kt">str</span><span class="p">,</span> <span class="n">len</span><span class="o">:</span> <span class="kt">uint</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_enum_elt</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_enum_end</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_option</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="o">&amp;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_seq</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Iter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">iter</span><span class="o">:</span> <span class="n">Iter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_map</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">K</span><span class="o">:</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">Self</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">Iter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">)</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">iter</span><span class="o">:</span> <span class="n">Iter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are many default methods, so only a handful of implementations need to be
specified. Now lets look at how they are used. Here&rsquo;s a simple
<code>AssertSerializer</code> that I use in my test suite to make sure I&rsquo;m serializing
properly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">AssertSerializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">iter</span><span class="o">:</span> <span class="n">Iter</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">Iter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;&gt;&gt;</span> <span class="n">AssertSerializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">new</span><span class="p">(</span><span class="n">iter</span><span class="o">:</span> <span class="n">Iter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AssertSerializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">AssertSerializer</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">iter</span><span class="o">:</span> <span class="n">iter</span><span class="p">,</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize</span><span class="o">&lt;</span><span class="nl">&#39;b</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="o">:</span> <span class="n">Token</span><span class="o">&lt;</span><span class="nl">&#39;b</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">Iter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Token</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;&gt;&gt;</span> <span class="n">Serializer</span><span class="o">&lt;</span><span class="n">Error</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">AssertSerializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_null</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">Token</span><span class="o">::</span><span class="n">Null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_bool</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">Token</span><span class="o">::</span><span class="nb">Bool</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_int</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">:</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">Token</span><span class="o">::</span><span class="nb">Int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Implementing <code>Serialize</code> for values follows the same pattern. Here&rsquo;s <code>bool</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="n">S</span><span class="o">:</span> <span class="n">Serializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="k">for</span> <span class="kt">bool</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">s</span><span class="p">.</span><span class="n">serialize_bool</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Vec&lt;T&gt;</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span>
</span><span class='line'>    <span class="n">S</span><span class="o">:</span> <span class="n">Serializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">E</span><span class="p">,</span>
</span><span class='line'>    <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">s</span><span class="p">.</span><span class="n">serialize_seq</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">iter</span><span class="p">())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">Serializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize_seq</span><span class="o">&lt;</span>
</span><span class='line'>        <span class="n">T</span><span class="o">:</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">AssertSerializer</span><span class="o">&lt;</span><span class="n">Iter</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Error</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SeqIter</span><span class="o">:</span> <span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="k">mut</span> <span class="n">iter</span><span class="o">:</span> <span class="n">SeqIter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">Error</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">iter</span><span class="p">.</span><span class="n">size_hint</span><span class="p">();</span>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">Token</span><span class="o">::</span><span class="n">SeqStart</span><span class="p">(</span><span class="n">len</span><span class="p">)));</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">elt</span> <span class="k">in</span> <span class="n">iter</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">elt</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">serialize</span><span class="p">(</span><span class="n">Token</span><span class="o">::</span><span class="n">SeqEnd</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And structs:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">struct</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">a</span><span class="o">:</span> <span class="p">(),</span>
</span><span class='line'>    <span class="n">b</span><span class="o">:</span> <span class="kt">uint</span><span class="p">,</span>
</span><span class='line'>    <span class="n">c</span><span class="o">:</span> <span class="n">TreeMap</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">char</span><span class="o">&gt;&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span>
</span><span class='line'>  <span class="n">S</span><span class="o">:</span> <span class="n">Serializer</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>  <span class="n">E</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">Serialize</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">E</span><span class="o">&gt;</span> <span class="k">for</span> <span class="n">Foo</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">serialize</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">S</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">E</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">serialize_struct_start</span><span class="p">(</span><span class="s">&quot;Foo&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="k">u</span><span class="p">));</span>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">serialize_struct_elt</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">a</span><span class="p">));</span>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">serialize_struct_elt</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">b</span><span class="p">));</span>
</span><span class='line'>        <span class="n">try</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">serialize_struct_elt</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">c</span><span class="p">));</span>
</span><span class='line'>        <span class="n">s</span><span class="p">.</span><span class="n">serialize_struct_end</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Much simpler than deserialization.</p>

<h2>Performance</h2>

<p>So how does it perform? Here&rsquo;s the serialization benchmarks, with yet another
ordering. This time sorted by the performance:</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library         </th>
<th> format                 </th>
<th> serialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> Rust     </td>
<td> capnproto-rust  </td>
<td> Cap&#8217;n Proto (unpacked) </td>
<td> 4349                 </td>
</tr>
<tr>
<td> Go       </td>
<td> go-capnproto    </td>
<td> Cap&#8217;n Proto            </td>
<td> 3824.20              </td>
</tr>
<tr>
<td> Rust     </td>
<td> bincode         </td>
<td> Binary                 </td>
<td> 1020                 </td>
</tr>
<tr>
<td> Go       </td>
<td> gogoprotobuf    </td>
<td> Protocol Buffers       </td>
<td> 596.78               </td>
</tr>
<tr>
<td> Rust     </td>
<td> capnproto-rust  </td>
<td> Cap&#8217;n Proto (packed)   </td>
<td> 583                  </td>
</tr>
<tr>
<td> Rust     </td>
<td> rust-msgpack    </td>
<td> MessagePack            </td>
<td> 397                  </td>
</tr>
<tr>
<td> Rust     </td>
<td> rust-protobuf   </td>
<td> Protocol Buffers       </td>
<td> 357                  </td>
</tr>
<tr>
<td> C++      </td>
<td> rapidjson       </td>
<td> JSON                   </td>
<td> 304                  </td>
</tr>
<tr>
<td> <strong>Rust</strong> </td>
<td> <strong>serde::json</strong> </td>
<td> <strong>JSON</strong>               </td>
<td> <strong>222</strong>              </td>
</tr>
<tr>
<td> Go       </td>
<td> goprotobuf      </td>
<td> Protocol Buffers       </td>
<td> 214.68               </td>
</tr>
<tr>
<td> Go       </td>
<td> ffjson          </td>
<td> JSON                   </td>
<td> 147.37               </td>
</tr>
<tr>
<td> Rust     </td>
<td> serialize::json </td>
<td> JSON                   </td>
<td> 147                  </td>
</tr>
<tr>
<td> Go       </td>
<td> encoding/json   </td>
<td> JSON                   </td>
<td> 80.49                </td>
</tr>
</tbody>
</table>


<p><code>serde::json</code> is doing pretty good! It still has got a ways to go to catch up
to <a href="https://github.com/miloyip/rapidjson">rapidjson</a>, but it&rsquo;s pretty cool it&rsquo;s
beating <a href="https://github.com/golang/protobuf">goprotobuf</a> out of the box :)</p>

<p>Here are the deserialization numbers:</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library         </th>
<th> format                  </th>
<th> deserialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> Rust     </td>
<td> capnproto-rust  </td>
<td> Cap&#8217;n Proto (unpacked)  </td>
<td> 2185                   </td>
</tr>
<tr>
<td> Go       </td>
<td> go-capnproto    </td>
<td> Cap&#8217;n Proto (zero copy) </td>
<td> 1407.95                </td>
</tr>
<tr>
<td> Go       </td>
<td> go-capnproto    </td>
<td> Cap&#8217;n Proto             </td>
<td> 711.77                 </td>
</tr>
<tr>
<td> Rust     </td>
<td> capnproto-rust  </td>
<td> Cap&#8217;n Proto (packed)    </td>
<td> 351                    </td>
</tr>
<tr>
<td> Go       </td>
<td> gogoprotobuf    </td>
<td> Protocol Buffers        </td>
<td> 272.68                 </td>
</tr>
<tr>
<td> C++      </td>
<td> rapidjson       </td>
<td> JSON (sax)              </td>
<td> 189                    </td>
</tr>
<tr>
<td> C++      </td>
<td> rapidjson       </td>
<td> JSON (dom)              </td>
<td> 162                    </td>
</tr>
<tr>
<td> Rust     </td>
<td> rust-msgpack    </td>
<td> MessagePack             </td>
<td> 138                    </td>
</tr>
<tr>
<td> Rust     </td>
<td> rust-protobuf   </td>
<td> Protocol Buffers        </td>
<td> 129                    </td>
</tr>
<tr>
<td> Go       </td>
<td> ffjson          </td>
<td> JSON                    </td>
<td> 95.06                  </td>
</tr>
<tr>
<td> Rust     </td>
<td> bincode         </td>
<td> Binary                  </td>
<td> 80                     </td>
</tr>
<tr>
<td> Go       </td>
<td> goprotobuf      </td>
<td> Protocol Buffers        </td>
<td> 79.78                  </td>
</tr>
<tr>
<td> <strong>Rust</strong> </td>
<td> <strong>serde::json</strong> </td>
<td> <strong>JSON</strong>                </td>
<td> <strong>67</strong>                 </td>
</tr>
<tr>
<td> Rust     </td>
<td> serialize::json </td>
<td> JSON                    </td>
<td> 24                     </td>
</tr>
<tr>
<td> Go       </td>
<td> encoding/json   </td>
<td> JSON                    </td>
<td> 22.79                  </td>
</tr>
</tbody>
</table>


<p>Well on the plus side, <code>serde::json</code> nearly 3 times faster than
<code>libserialize::json</code>. On the downside rapidjson is nearly 3 times faster than
us in it&rsquo;s SAX style parsing. Even the newly added deserialization support in
<a href="https://github.com/pquerna/ffjson">ffjson</a> is 1.4 times faster than us. So we
got more work cut out for us!</p>

<p>Next time, serde2!</p>

<p>PS: I&rsquo;m definitely getting close to the end of my story, and while I have some
better numbers with serde2, nothing is quite putting me in the rapidjson
range. Anyone want to help optimize
<a href="https://github.com/erickt/rust-serde">serde</a>? I would greatly appreciate the help!</p>

<p>PPS: I&rsquo;ve gotten a number of requests for my
<a href="https://github.com/erickt/rust-serialization-benchmarks">serialization benchmarks</a>
to be ported over to other languages and libraries. Especially a C++ version
of Cap&#8217;n Proto. Unfortunately I don&rsquo;t really have the time to do it myself.
Would anyone be up for helping to implement it?</p>

<p>comments on <a href="https://www.reddit.com/r/rust/comments/2p85za/rewriting_rust_serialization_part_3_introducing/">reddit</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/13/rust-and-mdbm/">Using Rust to Make a Safer Interface for Yahoo&#8217;s Fast MDBM Database</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-12-13T11:09:19-08:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>11:09 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m really supposed to be working on my
<a href="http://erickt.github.io/blog/categories/serialization/">serialization series</a>,
 but I just saw a neat new library that was open sourced by Yahoo a couple days
ago called <a href="https://github.com/yahoo/mdbm">MDBM</a> on
<a href="https://news.ycombinator.com/item?id=8732891">Hacker News</a>. I know nothing
about the library, but there are some really neat claims:</p>

<ol>
<li>It&rsquo;s supposed to be fast, and that&rsquo;s always nice.</li>
<li>It&rsquo;s supposed to have a really slim interface.</li>
<li>It&rsquo;s so fast because it&rsquo;s passing around naked pointers to mmapped files,
which is terribly unsafe. Unless you got rust which can prove that those
pointers won&rsquo;t escape :)</li>
</ol>


<p>So I wanted to see how easy it&rsquo;d be to make a Rust binding for the project.
If you want to follow along, first make sure you have
 <a href="http://www.rust-lang.org/install.html">rust installed</a>. Unfortunately it
looks like MDBM only supports Linux and FreeBSD, so I had to build out a Fedora
VM to test this out on. I <em>think</em> this is all you need to build it:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% git clone https://github.com/yahoo/mdbm
</span><span class='line'>% cd mdbm/redhat
</span><span class='line'>% make
</span><span class='line'>% rpm -Uvh ~/rpmbuild/RPMS/x86_64/mdbm-4.11.1-1.fc21.x86_64.rpm
</span><span class='line'>% rpm -Uvh ~/rpmbuild/RPMS/x86_64/mdbm-devel-4.11.1-1.fc21.x86_64.rpm</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately it&rsquo;s only for linux, and I got a mac, but it turns out there&rsquo;s
plenty I can do to prep while VirtualBox and Fedora 21 download. Lets start out
by creating our project with <a href="https://crates.io">cargo</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% cargo new mdbm
</span><span class='line'>% cd rust-mdbm</span></code></pre></td></tr></table></div></figure>


<p>(Right now there&rsquo;s no way to have the name be different than the path, so edit
<code>Cargo.toml</code> to rename the project to <code>mdbm</code>. I filed
<a href="https://github.com/rust-lang/cargo/issues/1030">#1030</a> to get that
implemented).</p>

<p>By convention, we put bindgen packages into <code>$name-sys</code>, so make that crate as
well:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% cargo new --no-git mdbm-sys
</span><span class='line'>% cd mdbm-sys</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;ve got a really cool tool called
<a href="https://github.com/crabtw/rust-bindgen">bindgen</a>, which uses clang to parse
header files and convert them into an unsafe rust interface. So lets check out
MDBM, and generate a crate to wrap it up in.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% cd ../..
</span><span class='line'>% git clone git@github.com:crabtw/rust-bindgen.git
</span><span class='line'>% cd rust-bindgen
</span><span class='line'>% cargo build
</span><span class='line'>% cd ..
</span><span class='line'>% git clone git@github.com:yahoo/mdbm.git
</span><span class='line'>% cd rust-mdbm/mdbm-sys
</span><span class='line'>% DYLD_LIBRARY_PATH=/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib \
</span><span class='line'>  ~/rust/rust-bindgen/target/bindgen \
</span><span class='line'>  -lmdbm \
</span><span class='line'>  -o src/lib.rs \
</span><span class='line'>  mdbm/include/mdbm.h</span></code></pre></td></tr></table></div></figure>


<p>Pretty magical. Make sure it builds:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>% cargo build
</span><span class='line'>/Users/erickt/rust-mdbm/mdbm-sys/src/lib.rs:3:21: 3:25 error: failed to resolve. Maybe a missing `extern crate libc`?
</span><span class='line'>/Users/erickt/rust-mdbm/mdbm-sys/src/lib.rs:3 pub type __int8_t = ::libc::c_char;
</span><span class='line'>                                                                  ^~~~
</span><span class='line'>/Users/erickt/rust-mdbm/mdbm-sys/src/lib.rs:3:21: 3:35 error: use of undeclared type name `libc::c_char`
</span><span class='line'>/Users/erickt/rust-mdbm/mdbm-sys/src/lib.rs:3 pub type __int8_t = ::libc::c_char;
</span><span class='line'>                                                                  ^~~~~~~~~~~~~~
</span><span class='line'>/Users/erickt/rust-mdbm/mdbm-sys/src/lib.rs:4:22: 4:26 error: failed to resolve. Maybe a missing `extern crate libc`?
</span><span class='line'>/Users/erickt/rust-mdbm/mdbm-sys/src/lib.rs:4 pub type __uint8_t = ::libc::c_uchar;
</span><span class='line'>                                                                   ^~~~
</span><span class='line'>...</span></code></pre></td></tr></table></div></figure>


<p>Nope! The problem is that we don&rsquo;t have the <code>libc</code> crate imported. We don&rsquo;t
have a convention yet for this, but I like to do is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>mv src/lib.rs src/ffi.rs</span></code></pre></td></tr></table></div></figure>


<p>And create a <code>src/lib.rs</code> that contains:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="n">allow</span><span class="p">(</span><span class="n">non_camel_case_types</span><span class="p">)]</span>
</span><span class='line'><span class="err">#</span><span class="o">!</span><span class="p">[</span><span class="n">allow</span><span class="p">(</span><span class="n">non_snake_case</span><span class="p">)]</span>
</span><span class='line'>
</span><span class='line'><span class="k">extern</span> <span class="n">crate</span> <span class="n">libc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">type</span> <span class="n">__builtin_va_list</span> <span class="o">=</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_void</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">include</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;ffi.rs&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This lets me run bindgen later on without mucking up the library. This now
compiles. Next up is our high level interface. Add <code>mdbm-sys</code> to our high level
interface by adding this to the <code>rust-mdbm/Cargo.toml</code> file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='toml'><span class='line'><span class="p">[</span><span class="n">dependencies</span><span class="p">.</span><span class="n">mdbm-sys</span><span class="p">]</span>
</span><span class='line'><span class="n">path</span> <span class="o">=</span> <span class="s">&quot;mdbm-sys&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>By now I got my VirtualBox setup working, so now to the actual code! Lets start
with a barebones wrapper around the database:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">struct</span> <span class="n">MDBM</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">db</span><span class="o">:</span> <span class="o">*</span><span class="k">mut</span> <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">MDBM</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next is the constructor and destructor. I&rsquo;m hardcoding things for now and using
IoError, since MDBM appears to log everything to the ERRNO:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">MDBM</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">new</span><span class="p">(</span>
</span><span class='line'>        <span class="n">path</span><span class="o">:</span> <span class="o">&amp;</span><span class="nb">Path</span><span class="p">,</span>
</span><span class='line'>        <span class="n">flags</span><span class="o">:</span> <span class="kt">uint</span><span class="p">,</span>
</span><span class='line'>        <span class="n">mode</span><span class="o">:</span> <span class="kt">uint</span><span class="p">,</span>
</span><span class='line'>        <span class="n">psize</span><span class="o">:</span> <span class="kt">uint</span><span class="p">,</span>
</span><span class='line'>        <span class="n">presize</span><span class="o">:</span> <span class="kt">uint</span>
</span><span class='line'>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">MDBM</span><span class="p">,</span> <span class="n">IoError</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">to_c_str</span><span class="p">();</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">db</span> <span class="o">=</span> <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">mdbm_open</span><span class="p">(</span>
</span><span class='line'>                <span class="n">path</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">flags</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">,</span>
</span><span class='line'>                <span class="n">mode</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">,</span>
</span><span class='line'>                <span class="n">psize</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">,</span>
</span><span class='line'>                <span class="n">presize</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="n">db</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">Err</span><span class="p">(</span><span class="n">IoError</span><span class="o">::</span><span class="n">last_error</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">Ok</span><span class="p">(</span><span class="n">MDBM</span> <span class="p">{</span> <span class="n">db</span><span class="o">:</span> <span class="n">db</span> <span class="p">})</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="nb">Drop</span> <span class="k">for</span> <span class="n">MDBM</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="nb">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">mdbm_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">);</span>
</span><span class='line'>            <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">mdbm_close</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pretty straightforward translation of the examples with some hardcoded values
to start out. Next up is a wrapper around MDBM&rsquo;s <code>datum</code> type, which is the
type used for both keys and values. <code>datum</code> is just a simple struct containing
a pointer and length, pretty much analogous to our <code>&amp;[u8]</code> slices. However our
slices are much more powerful because our type system can guarantee that in
safe Rust, these slices can never outlive where they are derived from:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">struct</span> <span class="n">Datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">bytes</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="n">Datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">new</span><span class="p">(</span><span class="n">bytes</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Datum</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Datum</span> <span class="p">{</span> <span class="n">bytes</span><span class="o">:</span> <span class="n">bytes</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">to_raw_datum</span><span class="p">(</span><span class="n">datum</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">Datum</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">datum</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">datum</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">dptr</span><span class="o">:</span> <span class="n">datum</span><span class="p">.</span><span class="n">bytes</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">_</span><span class="p">,</span>
</span><span class='line'>        <span class="n">dsize</span><span class="o">:</span> <span class="n">datum</span><span class="p">.</span><span class="n">bytes</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And for convenience, lets add a <code>AsDatum</code> conversion method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">trait</span> <span class="n">AsDatum</span> <span class="k">for</span> <span class="nb">Sized</span><span class="o">?</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">as_datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;a</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="nb">Sized</span><span class="o">?</span> <span class="n">T</span><span class="o">:</span> <span class="n">AsDatum</span><span class="o">&gt;</span> <span class="n">AsDatum</span> <span class="k">for</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="n">T</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">as_datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;a</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="p">).</span><span class="n">as_datum</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">AsDatum</span> <span class="k">for</span> <span class="p">[</span><span class="kt">u8</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">as_datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;a</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Datum</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="n">AsDatum</span> <span class="k">for</span> <span class="kt">str</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">as_datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;a</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">as_datum</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And finally, we got setting and getting a key-value. Setting is pretty
straightforward. The only fun thing is using the <code>AsDatum</code> constraints so we
can do <code>db.set(&amp;"foo", &amp;"bar", 0)</code> instead of
<code>db.set(Datum::new(&amp;"foo".as_slice()), Datum::new("bar".as_slice()), 0)</code>.
we&rsquo;re copying into the database, we don&rsquo;t have to worry about lifetimes yet:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">MDBM</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="c-Doc">/// Set a key.</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">set</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">K</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">V</span><span class="p">,</span> <span class="n">flags</span><span class="o">:</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="n">IoError</span><span class="o">&gt;</span> <span class="n">where</span>
</span><span class='line'>        <span class="n">K</span><span class="o">:</span> <span class="n">AsDatum</span><span class="p">,</span>
</span><span class='line'>        <span class="n">V</span><span class="o">:</span> <span class="n">AsDatum</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">mdbm_store</span><span class="p">(</span>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">,</span>
</span><span class='line'>                <span class="n">to_raw_datum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">as_datum</span><span class="p">()),</span>
</span><span class='line'>                <span class="n">to_raw_datum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">.</span><span class="n">as_datum</span><span class="p">()),</span>
</span><span class='line'>                <span class="n">flags</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">Err</span><span class="p">(</span><span class="n">IoError</span><span class="o">::</span><span class="n">last_error</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>MDBM requires the database to be locked in order to get the keys. This os
where things get fun in order to prevent those interior pointers from escaping.
We&rsquo;ll create another wrapper type that manages the lock, and uses RAII to
unlock when we&rsquo;re done. We tie the lifetime of the <code>Lock</code> to the lifetime of
the database and key, which prevents it from outliving either object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="n">MDBM</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="c-Doc">/// Lock a key.</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">lock</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="p">,</span> <span class="n">K</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;a</span> <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="n">K</span><span class="p">,</span> <span class="n">flags</span><span class="o">:</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Lock</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">IoError</span><span class="o">&gt;</span> <span class="n">where</span>
</span><span class='line'>        <span class="n">K</span><span class="o">:</span> <span class="n">AsDatum</span><span class="p">,</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">rc</span> <span class="o">=</span> <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">mdbm_lock_smart</span><span class="p">(</span>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">,</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="n">to_raw_datum</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">as_datum</span><span class="p">()),</span>
</span><span class='line'>                <span class="n">flags</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">)</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Ok</span><span class="p">(</span><span class="n">Lock</span> <span class="p">{</span> <span class="n">db</span><span class="o">:</span> <span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">:</span> <span class="n">key</span><span class="p">.</span><span class="n">as_datum</span><span class="p">()</span> <span class="p">})</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Err</span><span class="p">(</span><span class="n">IoError</span><span class="o">::</span><span class="n">last_error</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">pub</span> <span class="k">struct</span> <span class="n">Lock</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">db</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="n">MDBM</span><span class="p">,</span>
</span><span class='line'>    <span class="n">key</span><span class="o">:</span> <span class="n">Datum</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#[unsafe_destructor]</span>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="nb">Drop</span> <span class="k">for</span> <span class="n">Lock</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fn</span> <span class="nb">drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">mdbm_unlock_smart</span><span class="p">(</span>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">db</span><span class="p">,</span>
</span><span class='line'>                <span class="o">&amp;</span><span class="n">to_raw_datum</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">key</span><span class="p">),</span>
</span><span class='line'>                <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>(Note that I&rsquo;ve heard <code>#[unsafe_destrutor]</code> as used here may become unnecessary
in 1.0).</p>

<p>Finally, let&rsquo;s get our value! Assuming the value exists, we tie the lifetime of
the <code>Lock</code> to the lifetime of the returned <code>&amp;[u8]</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="n">Lock</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="c-Doc">/// Fetch a key.</span>
</span><span class='line'>    <span class="k">pub</span> <span class="k">fn</span> <span class="n">get</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">&#39;a</span> <span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">&#39;a</span> <span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">mdbm_sys</span><span class="o">::</span><span class="n">mdbm_fetch</span><span class="p">(</span>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">db</span><span class="p">.</span><span class="n">db</span><span class="p">,</span>
</span><span class='line'>                <span class="n">to_raw_datum</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">key</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="n">dptr</span><span class="p">.</span><span class="n">is_null</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">None</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// we want to constrain the ptr to our lifetime.</span>
</span><span class='line'>                <span class="kd">let</span> <span class="n">ptr</span><span class="o">:</span> <span class="o">&amp;*</span><span class="kr">const</span> <span class="kt">u8</span> <span class="o">=</span> <span class="n">mem</span><span class="o">::</span><span class="n">transmute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">.</span><span class="n">dptr</span><span class="p">);</span>
</span><span class='line'>                <span class="nb">Some</span><span class="p">(</span><span class="n">slice</span><span class="o">::</span><span class="n">from_raw_buf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">dsize</span> <span class="k">as</span> <span class="kt">uint</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now to verify it works:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[test]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">test</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">db</span> <span class="o">=</span> <span class="n">MDBM</span><span class="o">::</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="nb">Path</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;test.db&quot;</span><span class="p">),</span>
</span><span class='line'>        <span class="n">super</span><span class="o">::</span><span class="n">MDBM_O_RDWR</span> <span class="o">|</span> <span class="n">super</span><span class="o">::</span><span class="n">MDBM_O_CREAT</span><span class="p">,</span>
</span><span class='line'>        <span class="mo">0o644</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">0</span>
</span><span class='line'>    <span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="s">&quot;world&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// key needs to be an lvalue so the lock can hold a reference to</span>
</span><span class='line'>        <span class="c1">// it.</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;hello&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Lock the key. RAII will unlock it when we exit this scope.</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Convert the value into a string. The lock is still live at this</span>
</span><span class='line'>        <span class="c1">// point.</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="kt">str</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>        <span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;world&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">println</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;hello: {}&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which when run with <code>cargo test</code>, produces:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'>   <span class="n">Compiling</span> <span class="n">rust</span><span class="o">-</span><span class="n">mdbm</span> <span class="n">v0</span><span class="p">.</span><span class="mf">0.1</span> <span class="p">(</span><span class="n">file</span><span class="o">:</span><span class="c-Doc">///home/erickt/Projects/rust-mdbm)</span>
</span><span class='line'>     <span class="n">Running</span> <span class="n">target</span><span class="o">/</span><span class="n">rust</span><span class="o">-</span><span class="n">mdbm</span><span class="o">-</span><span class="mi">98</span><span class="n">b81ab156dc1e5f</span>
</span><span class='line'>
</span><span class='line'><span class="n">running</span> <span class="mi">1</span> <span class="n">test</span>
</span><span class='line'><span class="n">test</span> <span class="n">tests</span><span class="o">::</span><span class="n">test_set_get</span> <span class="p">...</span> <span class="n">ok</span>
</span><span class='line'>
</span><span class='line'><span class="n">test</span> <span class="n">result</span><span class="o">:</span> <span class="n">ok</span><span class="p">.</span> <span class="mi">1</span> <span class="n">passed</span><span class="p">;</span> <span class="mi">0</span> <span class="n">failed</span><span class="p">;</span> <span class="mi">0</span> <span class="n">ignored</span><span class="p">;</span> <span class="mi">0</span> <span class="n">measured</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Doc</span><span class="o">-</span><span class="n">tests</span> <span class="n">rust</span><span class="o">-</span><span class="n">mdbm</span>
</span><span class='line'>
</span><span class='line'><span class="n">running</span> <span class="mi">0</span> <span class="n">tests</span>
</span><span class='line'>
</span><span class='line'><span class="n">test</span> <span class="n">result</span><span class="o">:</span> <span class="n">ok</span><span class="p">.</span> <span class="mi">0</span> <span class="n">passed</span><span class="p">;</span> <span class="mi">0</span> <span class="n">failed</span><span class="p">;</span> <span class="mi">0</span> <span class="n">ignored</span><span class="p">;</span> <span class="mi">0</span> <span class="n">measured</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we want to make sure invalid behavior is a compile-time error. First, make
sure we don&rsquo;t leak the keys:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[test]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">test_keys_cannot_escape</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">db</span> <span class="o">=</span> <span class="n">MDBM</span><span class="o">::</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="nb">Path</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;test.db&quot;</span><span class="p">),</span>
</span><span class='line'>        <span class="n">super</span><span class="o">::</span><span class="n">MDBM_O_RDWR</span> <span class="o">|</span> <span class="n">super</span><span class="o">::</span><span class="n">MDBM_O_CREAT</span><span class="p">,</span>
</span><span class='line'>        <span class="mo">0o644</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">0</span>
</span><span class='line'>    <span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="s">&quot;world&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>        <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">as_slice</span><span class="p">(),</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which errors with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">217</span><span class="o">:</span><span class="mi">22</span><span class="o">:</span> <span class="mi">217</span><span class="o">:</span><span class="mi">25</span> <span class="n">error</span><span class="o">:</span> <span class="err">`</span><span class="n">key</span><span class="err">`</span> <span class="n">does</span> <span class="n">not</span> <span class="n">live</span> <span class="n">long</span> <span class="n">enough</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">217</span>             <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">as_slice</span><span class="p">(),</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'>                                    <span class="o">^~~</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">215</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span> <span class="mi">218</span><span class="o">:</span><span class="mi">10</span> <span class="n">note</span><span class="o">:</span> <span class="n">reference</span> <span class="n">must</span> <span class="kr">be</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">expression</span> <span class="n">at</span> <span class="mi">215</span><span class="o">:</span><span class="mf">16.</span><span class="p">..</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">215</span>         <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">216</span>             <span class="kd">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">217</span>             <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">as_slice</span><span class="p">(),</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">218</span>         <span class="p">};</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">215</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span> <span class="mi">218</span><span class="o">:</span><span class="mi">10</span> <span class="n">note</span><span class="o">:</span> <span class="p">...</span><span class="n">but</span> <span class="n">borrowed</span> <span class="n">value</span> <span class="n">is</span> <span class="n">only</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">block</span> <span class="n">at</span> <span class="mi">215</span><span class="o">:</span><span class="mi">16</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">215</span>         <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">216</span>             <span class="kd">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">vec</span><span class="o">!</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">217</span>             <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">as_slice</span><span class="p">(),</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">218</span>         <span class="p">};</span>
</span><span class='line'><span class="n">error</span><span class="o">:</span> <span class="n">aborting</span> <span class="n">due</span> <span class="n">to</span> <span class="n">previous</span> <span class="n">error</span>
</span></code></pre></td></tr></table></div></figure>


<p>And confirm the value doesn&rsquo;t leak either:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[test]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">test_values_cannot_escape</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">db</span> <span class="o">=</span> <span class="n">MDBM</span><span class="o">::</span><span class="n">new</span><span class="p">(</span>
</span><span class='line'>        <span class="o">&amp;</span><span class="nb">Path</span><span class="o">::</span><span class="n">new</span><span class="p">(</span><span class="s">&quot;test.db&quot;</span><span class="p">),</span>
</span><span class='line'>        <span class="n">super</span><span class="o">::</span><span class="n">MDBM_O_RDWR</span> <span class="o">|</span> <span class="n">super</span><span class="o">::</span><span class="n">MDBM_O_CREAT</span><span class="p">,</span>
</span><span class='line'>        <span class="mo">0o644</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>        <span class="mi">0</span>
</span><span class='line'>    <span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="s">&quot;world&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;hello&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>        <span class="kt">str</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Which errors with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">237</span><span class="o">:</span><span class="mi">34</span><span class="o">:</span> <span class="mi">237</span><span class="o">:</span><span class="mi">37</span> <span class="n">error</span><span class="o">:</span> <span class="err">`</span><span class="n">key</span><span class="err">`</span> <span class="n">does</span> <span class="n">not</span> <span class="n">live</span> <span class="n">long</span> <span class="n">enough</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">237</span>             <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>                                                <span class="o">^~~</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">233</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span> <span class="mi">239</span><span class="o">:</span><span class="mi">10</span> <span class="n">note</span><span class="o">:</span> <span class="n">reference</span> <span class="n">must</span> <span class="kr">be</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">expression</span> <span class="n">at</span> <span class="mi">233</span><span class="o">:</span><span class="mf">16.</span><span class="p">..</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">233</span>         <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">234</span>             <span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="s">&quot;world&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">235</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">236</span>             <span class="kd">let</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;hello&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">237</span>             <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">238</span>             <span class="kt">str</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'>               <span class="p">...</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">233</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span> <span class="mi">239</span><span class="o">:</span><span class="mi">10</span> <span class="n">note</span><span class="o">:</span> <span class="p">...</span><span class="n">but</span> <span class="n">borrowed</span> <span class="n">value</span> <span class="n">is</span> <span class="n">only</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">block</span> <span class="n">at</span> <span class="mi">233</span><span class="o">:</span><span class="mi">16</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">233</span>         <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">234</span>             <span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="s">&quot;world&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">235</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">236</span>             <span class="kd">let</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;hello&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">237</span>             <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">238</span>             <span class="kt">str</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'>               <span class="p">...</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">238</span><span class="o">:</span><span class="mi">28</span><span class="o">:</span> <span class="mi">238</span><span class="o">:</span><span class="mi">33</span> <span class="n">error</span><span class="o">:</span> <span class="err">`</span><span class="n">value</span><span class="err">`</span> <span class="n">does</span> <span class="n">not</span> <span class="n">live</span> <span class="n">long</span> <span class="n">enough</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">238</span>             <span class="kt">str</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'>                                          <span class="o">^~~~~</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">233</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span> <span class="mi">239</span><span class="o">:</span><span class="mi">10</span> <span class="n">note</span><span class="o">:</span> <span class="n">reference</span> <span class="n">must</span> <span class="kr">be</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">expression</span> <span class="n">at</span> <span class="mi">233</span><span class="o">:</span><span class="mf">16.</span><span class="p">..</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">233</span>         <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">234</span>             <span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="s">&quot;world&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">235</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">236</span>             <span class="kd">let</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;hello&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">237</span>             <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">238</span>             <span class="kt">str</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'>               <span class="p">...</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">233</span><span class="o">:</span><span class="mi">17</span><span class="o">:</span> <span class="mi">239</span><span class="o">:</span><span class="mi">10</span> <span class="n">note</span><span class="o">:</span> <span class="p">...</span><span class="n">but</span> <span class="n">borrowed</span> <span class="n">value</span> <span class="n">is</span> <span class="n">only</span> <span class="n">valid</span> <span class="k">for</span> <span class="n">the</span> <span class="n">block</span> <span class="n">at</span> <span class="mi">233</span><span class="o">:</span><span class="mi">16</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">233</span>         <span class="kd">let</span> <span class="n">_</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">234</span>             <span class="n">db</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="o">&amp;</span><span class="s">&quot;hello&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="s">&quot;world&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">235</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">236</span>             <span class="kd">let</span> <span class="n">key</span> <span class="o">=</span> <span class="s">&quot;hello&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">237</span>             <span class="kd">let</span> <span class="n">value</span> <span class="o">=</span> <span class="n">db</span><span class="p">.</span><span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="o">:</span><span class="mi">238</span>             <span class="kt">str</span><span class="o">::</span><span class="n">from_utf8</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">()</span>
</span><span class='line'>                                                     <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Success! Not too bad for 2 hours of work. Baring bugs, this <code>mdbm</code>
library should perform at roughly the same speed as the C library, but
eliminate many very painful bug opportunities that require tools like Valgrind
to debug.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/22/benchmarking-is-confusing/">Benchmarking Is Confusing in Low Level Rust</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-22T12:10:29-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>12:10 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Edit: you can find all the code in this post
<a href="https://github.com/erickt/rust-serialization-benchmarks/blob/master/rust/src/writer.rs">here</a>,
and I filed <a href="https://github.com/rust-lang/rust/issues/19281">19281</a> for the
regression I mentioned at the end of the post.</p>

<hr />

<p>Low level benchmarking is confusing and non-intuitive.</p>

<p>The end.</p>

<hr />

<p>Or not. Whatever. So I&rsquo;m trying to get my
implement-<code>Reader</code>-and-<code>Writer</code>-for-<code>&amp;[u8]</code> type PR
<a href="https://github.com/rust-lang/rust/pull/18980">#18980</a> landed. But
<a href="https://github.com/rust-lang/rust/pull/18980#issuecomment-63925495">Steven Fackler</a>
obnixously and correctly pointed out that this won&rsquo;t play that nicely with the
new <code>Reader</code> and <code>Writer</code> implementation for <code>Vec&lt;u8&gt;</code>. Grumble grumble. And then
<a href="https://github.com/rust-lang/rust/pull/18980#issuecomment-63927659">Alex Crichton</a>
had the gall to mention that a <code>Writer</code> for <code>mut &amp;[u8]</code> also probably won&rsquo;t be
that common either. Sure, he&rsquo;s write and all, but but I got it working without
needing an index! That means that the <code>&amp;mut [u8]</code> <code>Writer</code> only needs 2
pointers instead of <code>BufWriter</code>&rsquo;s three, so it just has to be faster! Well,
doesn&rsquo;t it?</p>

<p>Stupid benchmarks.</p>

<p>I got to say it&rsquo;s pretty addicting writing micro-benchmarks. It&rsquo;s a lot of fun
seeing how sensitive low-level code can be to just the smallest of tweaks. It&rsquo;s
also really annoying when you write something you think is pretty neat, then
you find it&rsquo;s chock-full of false dependencies between cache lines, or other
mean things CPUs like to impose on poor programmers.</p>

<p>Anyway, to start lets look at what should be the fastest way to write to a
buffer. Completely unsafely with no checks.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">unsafe</span> <span class="k">fn</span> <span class="n">do_copy_nonoverlapping_memory</span><span class="p">(</span>
</span><span class='line'>  <span class="k">mut</span> <span class="n">dst</span><span class="o">:</span> <span class="o">*</span><span class="k">mut</span> <span class="kt">u8</span><span class="p">,</span>
</span><span class='line'>  <span class="n">src</span><span class="o">:</span> <span class="o">*</span><span class="kr">const</span> <span class="kt">u8</span><span class="p">,</span>
</span><span class='line'>  <span class="n">len</span><span class="o">:</span> <span class="kt">uint</span><span class="p">,</span>
</span><span class='line'>  <span class="n">batches</span><span class="o">:</span> <span class="kt">uint</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">_</span> <span class="k">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batches</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ptr</span><span class="o">::</span><span class="n">copy_nonoverlapping_memory</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>        <span class="n">dst</span> <span class="o">=</span> <span class="n">dst</span><span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="n">len</span> <span class="k">as</span> <span class="kt">int</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#[test]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">test_copy_nonoverlapping_memory</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">dst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="p">[</span><span class="mi">0_</span><span class="k">u8</span><span class="p">,</span> <span class="p">..</span> <span class="n">BATCHES</span> <span class="o">*</span> <span class="n">SRC_LEN</span><span class="p">];</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">..</span> <span class="n">SRC_LEN</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">do_copy_nonoverlapping_memory</span><span class="p">(</span>
</span><span class='line'>            <span class="n">dst</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">src</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">src</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">BATCHES</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">assert</span><span class="o">!</span><span class="p">(</span><span class="n">dst</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">all</span><span class="p">(</span><span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="o">*</span><span class="n">c</span> <span class="o">==</span> <span class="mi">1</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With <code>SRC_LEN=4</code> and <code>BATCHES=128</code>, we get this. For fun I added the new
<code>libtest</code> from <a href="https://github.com/rust-lang/rust/pull/19233">#19233</a> that will
hopefully land soon. I also added also ran variations that explicitly inlined
and not inlined the inner function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">bench_copy_nonoverlapping_memory</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">50</span> <span class="o">|</span>   <span class="p">[</span><span class="o">-***</span><span class="err">#</span><span class="o">**------</span><span class="p">]</span>                        <span class="o">|</span> <span class="mi">200</span><span class="o">:</span>        <span class="mi">72</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">45</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">bench_copy_nonoverlapping_memory_inline_always</span> <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">50</span> <span class="o">|</span>       <span class="p">[</span><span class="o">---***</span><span class="err">#</span><span class="o">****************----------</span><span class="p">]</span><span class="o">|</span> <span class="mi">100</span><span class="o">:</span>        <span class="mi">65</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">39</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">bench_copy_nonoverlapping_memory_inline_never</span>  <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">500</span> <span class="o">|</span>      <span class="p">[</span><span class="o">------********</span><span class="err">#</span><span class="o">*********-------</span><span class="p">]</span> <span class="o">|</span> <span class="mi">1000</span><span class="o">:</span>       <span class="mi">747</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">393</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So overall it does quite well. Now lets compare with the code I wrote:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="nb">Writer</span> <span class="k">for</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="k">mut</span> <span class="p">[</span><span class="kt">u8</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Err</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">standard_error</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">EndOfFile</span><span class="p">));</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">dst_len</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">src_len</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">write_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">dst_len</span><span class="p">,</span> <span class="n">src_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">slice</span><span class="o">::</span><span class="n">bytes</span><span class="o">::</span><span class="n">copy_memory</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">.</span><span class="n">slice_to</span><span class="p">(</span><span class="n">write_len</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="o">*</span><span class="bp">self</span> <span class="o">=</span> <span class="n">mem</span><span class="o">::</span><span class="n">transmute</span><span class="p">(</span><span class="n">raw</span><span class="o">::</span><span class="n">Slice</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">data</span><span class="o">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">().</span><span class="n">offset</span><span class="p">(</span><span class="n">write_len</span> <span class="k">as</span> <span class="kt">int</span><span class="p">),</span>
</span><span class='line'>                <span class="n">len</span><span class="o">:</span> <span class="n">dst_len</span> <span class="o">-</span> <span class="n">write_len</span><span class="p">,</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">src_len</span> <span class="o">&gt;</span> <span class="n">dst_len</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Err</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">standard_error</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">ShortWrite</span><span class="p">(</span><span class="n">write_len</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And. Well. It didn&rsquo;t do that well.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_slice_writer</span>                             <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">500</span> <span class="o">|</span>   <span class="p">[</span><span class="o">------**</span><span class="err">#</span><span class="o">**--</span><span class="p">]</span>                      <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">920</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">448</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_slice_writer_inline_always</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span> <span class="p">[</span><span class="o">-**</span><span class="err">#</span><span class="o">*****---</span><span class="p">]</span>                         <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">711</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">405</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_slice_writer_inline_never</span>                <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span>   <span class="p">[</span><span class="o">-***</span><span class="err">#</span><span class="o">******---</span><span class="p">]</span>                     <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">838</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">474</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wow. That&rsquo;s pretty bad compared to the ideal.</p>

<p>Crud. So not only did I add an implementation that&rsquo;s probably going to not work
with <code>write!</code> and now it turns out the performance is pretty terrible. Inlining
isn&rsquo;t helping like it did in the unsafe case. So how&rsquo;s
<a href="https://github.com/rust-lang/rust/blob/master/src/libstd/io/mem.rs#L219">std::io::BufWriter</a>
compare?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">pub</span> <span class="k">struct</span> <span class="n">BufWriter</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">buf</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">&#39;a</span> <span class="k">mut</span> <span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
</span><span class='line'>    <span class="n">pos</span><span class="o">:</span> <span class="kt">uint</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="nb">Writer</span> <span class="k">for</span> <span class="n">BufWriter</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// return an error if the entire write does not fit in the buffer</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">cap</span> <span class="o">=</span> <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="bp">self</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos</span> <span class="p">};</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">cap</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">Err</span><span class="p">(</span><span class="n">IoError</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">kind</span><span class="o">:</span> <span class="n">io</span><span class="o">::</span><span class="n">OtherIoError</span><span class="p">,</span>
</span><span class='line'>                <span class="n">desc</span><span class="o">:</span> <span class="s">&quot;Trying to write past end of buffer&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">detail</span><span class="o">:</span> <span class="nb">None</span>
</span><span class='line'>            <span class="p">})</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">slice</span><span class="o">::</span><span class="n">bytes</span><span class="o">::</span><span class="n">copy_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="k">mut</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">..],</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&rsquo;s how it does:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_std_buf_writer</span>                           <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">50</span> <span class="o">|</span>     <span class="p">[</span><span class="o">------**************</span><span class="err">#</span><span class="o">******-------</span><span class="p">]</span> <span class="o">|</span> <span class="mi">100</span><span class="o">:</span>        <span class="mi">79</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_std_buf_writer_inline_always</span>             <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">50</span> <span class="o">|</span>    <span class="p">[</span><span class="o">-----************</span><span class="err">#</span><span class="o">*********-------</span><span class="p">]</span>  <span class="o">|</span> <span class="mi">100</span><span class="o">:</span>        <span class="mi">75</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">40</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_std_buf_writer_inline_never</span>              <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span>   <span class="p">[</span><span class="err">#</span><span class="o">****-----</span><span class="p">]</span>                         <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">705</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">337</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s just cruel. The optimization gods obviously hate me. So I started
playing with a lot of
<a href="https://github.com/erickt/rust-serialization-benchmarks/blob/master/rust/src/writer.rs">variations</a>
(it&rsquo;s my yeah yeah it&rsquo;s my serialization benchmark suite, I&rsquo;m planning on
making it more general purpose. Besides it&rsquo;s my suite and I can do whatever I
want with it, so there):</p>

<ul>
<li>(BufWriter0): Turning this <code>Writer</code> into a struct wrapper shouldn&rsquo;t do anything, and it
didn&rsquo;t.</li>
<li>(BufWriter1): There&rsquo;s error handling, does removing it help? Nope!</li>
<li>(BufWriter5): There&rsquo;s an implied branch in <code>let write_len = min(dst_len, src_len)</code>. We can
turn that into the branch-predictor-friendly:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="kd">let</span> <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">dst_len</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="k">as</span> <span class="kt">uint</span><span class="p">;</span>
</span><span class='line'><span class="kd">let</span> <span class="n">write_len</span> <span class="o">=</span> <span class="n">dst_len</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">src_len</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Doesn&rsquo;t matter, still performs the same.</p>

<ul>
<li>(BufWriter2): Fine then, optimization gods! Lets remove the branch altogether and just
  always advance the slice <code>src.len()</code> bytes! Damn the safety! That, of course,
works. I can hear them giggle.</li>
<li>(BufWriter3): Maybe, just maybe there&rsquo;s something weird going on with
  inlining across crates? Lets copy <code>std::io::BufWriter</code> and make sure that
  it&rsquo;s still nearly optimal. It still is.</li>
<li>(BufWriter6): Technically the <code>min(dst_len, src_len)</code> is a bounds check, so
we could switch from the bounds checked <code>std.slice::bytes::copy_memory</code> to
  the unsafe <code>std::ptr::copy_nonoverlapping_memory</code>, but that also doesn&rsquo;t
  help.</li>
<li>(BufWriter7): Might as well and apply the last trick to <code>std::io::BufWriter</code>,
  and it does shave a couple nanoseconds off. It might be worth pushing it
  upstream:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_7</span>                             <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">50</span> <span class="o">|</span>   <span class="p">[</span><span class="o">-*</span><span class="err">#</span><span class="o">********--------------------------</span><span class="p">]</span><span class="o">|</span> <span class="mi">100</span><span class="o">:</span>        <span class="mi">55</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">44</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_7_inline_always</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">50</span> <span class="o">|</span>     <span class="p">[</span><span class="o">---------********</span><span class="err">#</span><span class="o">*********-------</span><span class="p">]</span> <span class="o">|</span> <span class="mi">100</span><span class="o">:</span>        <span class="mi">76</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">39</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_7_inline_never</span>                <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span>   <span class="p">[</span><span class="o">-***</span><span class="err">#</span><span class="o">****----</span><span class="p">]</span>                      <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">828</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">417</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>(BufWriter4): While I&rsquo;m using one less <code>uint</code> than <code>std::io::BufWriter</code>, I&rsquo;m
  doing two writes to advance my slice, one to advance the pointer, and one to
  shrink the length. <code>std::io::BufWriter</code> only has to advance it&rsquo;s <code>pos</code> index.
  But in this case if instead of treating the slice as a <code>(ptr, length)</code>, we
  can convert it into a <code>(start_ptr, end_ptr)</code>, where <code>start_ptr=ptr</code>, and
  <code>end_ptr=ptr+length</code>. This works! Ish:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_4</span>                             <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">80</span> <span class="o">|</span>   <span class="p">[</span><span class="o">--******</span><span class="err">#</span><span class="o">*******-----</span><span class="p">]</span>                <span class="o">|</span> <span class="mi">200</span><span class="o">:</span>       <span class="mi">109</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">59</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_4_inline_always</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">100</span> <span class="o">|</span>     <span class="p">[</span><span class="o">------***</span><span class="err">#</span><span class="o">******---</span><span class="p">]</span>               <span class="o">|</span> <span class="mi">200</span><span class="o">:</span>       <span class="mi">133</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">44</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_4_inline_never</span>                <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">500</span> <span class="o">|</span>      <span class="p">[</span><span class="o">-----***********</span><span class="err">#</span><span class="o">***********----</span><span class="p">]</span><span class="o">|</span> <span class="mi">1000</span><span class="o">:</span>       <span class="mi">778</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">426</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I know when I&rsquo;m defeated. Oh well. I guess I can at least update
<code>std::io::BufWriter</code> to support the new error handling approach:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="n">MyWriter</span> <span class="k">for</span> <span class="n">BufWriter10</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">my_write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">dst_len</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos</span> <span class="o">==</span> <span class="n">dst_len</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Err</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">standard_error</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">EndOfFile</span><span class="p">));</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">src_len</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">dst_len</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">write_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">src_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">slice</span><span class="o">::</span><span class="n">bytes</span><span class="o">::</span><span class="n">copy_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">[</span><span class="k">mut</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">..],</span> <span class="n">src</span><span class="p">[..</span><span class="n">write_len</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">src_len</span> <span class="o">&gt;</span> <span class="n">dst_len</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">Err</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">standard_error</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">ShortWrite</span><span class="p">(</span><span class="n">write_len</span><span class="p">)));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">write_len</span><span class="p">;</span>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>How&rsquo;s it do?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_10</span>                            <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span> <span class="p">[</span><span class="o">----**</span><span class="err">#</span><span class="o">***--</span><span class="p">]</span>                         <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">841</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">413</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_10_inline_always</span>              <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span>  <span class="p">[</span><span class="o">----**</span><span class="err">#</span><span class="o">***--</span><span class="p">]</span>                        <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">872</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">387</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_10_inline_never</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span>   <span class="p">[</span><span class="o">--******</span><span class="err">#</span><span class="o">**---</span><span class="p">]</span>                     <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">960</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">486</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Grumble grumble. It turns out that if we tweak the <code>copy_memory</code> line to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'>    <span class="n">slice</span><span class="o">::</span><span class="n">bytes</span><span class="o">::</span><span class="n">copy_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">[</span><span class="k">mut</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">..],</span> <span class="n">src</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>It shaves 674 nanoseconds off the run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_10</span>                            <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">200</span> <span class="o">|</span><span class="p">[</span><span class="o">---***</span><span class="err">#</span><span class="o">************------------</span><span class="p">]</span>        <span class="o">|</span> <span class="mi">400</span><span class="o">:</span>       <span class="mi">230</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">147</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_10_inline_always</span>              <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">200</span> <span class="o">|</span>   <span class="p">[</span><span class="o">-----********</span><span class="err">#</span><span class="o">*******------</span><span class="p">]</span>         <span class="o">|</span> <span class="mi">400</span><span class="o">:</span>       <span class="mi">280</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">128</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_10_inline_never</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span>   <span class="p">[</span><span class="o">--***</span><span class="err">#</span><span class="o">****----</span><span class="p">]</span>                     <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">885</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">475</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>But still no where near where we need to be. That suggests though that always
cutting down the <code>src</code>, which triggers another bounds check has some measurable
impact. So maybe I should only shrink the <code>src</code> slice when we know it needs to
be shrunk?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="n">MyWriter</span> <span class="k">for</span> <span class="n">BufWriter11</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">my_write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">[</span><span class="k">mut</span> <span class="bp">self</span><span class="p">.</span><span class="n">pos</span><span class="p">..];</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">dst_len</span> <span class="o">=</span> <span class="n">dst</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">dst_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">Err</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">standard_error</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">EndOfFile</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">src_len</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">dst_len</span> <span class="o">&gt;=</span> <span class="n">src_len</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ptr</span><span class="o">::</span><span class="n">copy_nonoverlapping_memory</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">dst</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">src</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">src_len</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="bp">self</span><span class="p">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">src_len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ptr</span><span class="o">::</span><span class="n">copy_nonoverlapping_memory</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">dst</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">src</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">dst_len</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="bp">self</span><span class="p">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">dst_len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="nb">Err</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">standard_error</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">ShortWrite</span><span class="p">(</span><span class="n">dst_len</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Lets see how it failed this time&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_11</span>                            <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">60</span> <span class="o">|</span>      <span class="p">[</span><span class="o">------********</span><span class="err">#</span><span class="o">*********-----</span><span class="p">]</span>     <span class="o">|</span> <span class="mi">100</span><span class="o">:</span>        <span class="mi">79</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">28</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_11_inline_always</span>              <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">60</span> <span class="o">|</span><span class="p">[</span><span class="o">-------******</span><span class="err">#</span><span class="o">*************-----------</span><span class="p">]</span>  <span class="o">|</span> <span class="mi">100</span><span class="o">:</span>        <span class="mi">72</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">35</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_11_inline_never</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span>  <span class="p">[</span><span class="o">--***</span><span class="err">#</span><span class="o">***----</span><span class="p">]</span>                       <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">835</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">423</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>No way. That actually worked?! That&rsquo;s awesome! I&rsquo;ll carve that out into another
PR. Maybe it&rsquo;ll work for my original version that doesn&rsquo;t use a <code>pos</code>?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="n">MyWriter</span> <span class="k">for</span> <span class="n">BufWriter12</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">my_write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">dst_len</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">dst_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">Err</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">standard_error</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">EndOfFile</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">src_len</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">dst_len</span> <span class="o">&gt;=</span> <span class="n">src_len</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ptr</span><span class="o">::</span><span class="n">copy_nonoverlapping_memory</span><span class="p">(</span>
</span><span class='line'>                    <span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">src</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">src_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">mem</span><span class="o">::</span><span class="n">transmute</span><span class="p">(</span><span class="n">raw</span><span class="o">::</span><span class="n">Slice</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">data</span><span class="o">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">().</span><span class="n">offset</span><span class="p">(</span><span class="n">src_len</span> <span class="k">as</span> <span class="kt">int</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">len</span><span class="o">:</span> <span class="n">dst_len</span> <span class="o">-</span> <span class="n">src_len</span><span class="p">,</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ptr</span><span class="o">::</span><span class="n">copy_nonoverlapping_memory</span><span class="p">(</span>
</span><span class='line'>                    <span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">src</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">dst_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="bp">self</span><span class="p">.</span><span class="n">dst</span> <span class="o">=</span> <span class="n">mem</span><span class="o">::</span><span class="n">transmute</span><span class="p">(</span><span class="n">raw</span><span class="o">::</span><span class="n">Slice</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">data</span><span class="o">:</span> <span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">().</span><span class="n">offset</span><span class="p">(</span><span class="n">dst_len</span> <span class="k">as</span> <span class="kt">int</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">len</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nb">Err</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">standard_error</span><span class="p">(</span><span class="n">io</span><span class="o">::</span><span class="n">ShortWrite</span><span class="p">(</span><span class="n">dst_len</span><span class="p">)))</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And yep, just as fast!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_12</span>                            <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">50</span> <span class="o">|</span><span class="p">[</span><span class="o">**</span><span class="err">#</span><span class="o">*----------------------------------</span><span class="p">]</span>   <span class="o">|</span> <span class="mi">80</span><span class="o">:</span>        <span class="mi">51</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">26</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_12_inline_always</span>              <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">50</span> <span class="o">|</span>  <span class="p">[</span><span class="o">--------**********</span><span class="err">#</span><span class="o">********------------</span><span class="p">]</span><span class="o">|</span> <span class="mi">90</span><span class="o">:</span>        <span class="mi">69</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">36</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_buf_writer_12_inline_never</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">800</span> <span class="o">|</span>  <span class="p">[</span><span class="o">---**</span><span class="err">#</span><span class="o">***-</span><span class="p">]</span>                          <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>      <span class="mi">1000</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">263</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point, both solutions are approximately just as fast as the unsafe
<code>ptr::copy_nonoverlapping_memory</code>! So that&rsquo;s awesome. Now would anyone really
care enough about the extra <code>uint</code>?  There may be a few very specialized cases
where that extra <code>uint</code> could cause a problem, but I&rsquo;m not sure if it&rsquo;s worth
it. What do you all think?</p>

<hr />

<p>I thought that was good, but since I&rsquo;m already here, how&rsquo;s the new <code>Vec&lt;u8&gt;</code>
writer doing? Here&rsquo;s the driver:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span> <span class="nb">Writer</span> <span class="k">for</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">push_all</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">impl</span> <span class="nb">Writer</span> <span class="k">for</span> <span class="n">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">buf</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">push_all</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#[bench]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">bench_std_vec_writer</span><span class="p">(</span><span class="n">b</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">test</span><span class="o">::</span><span class="n">Bencher</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">Vec</span><span class="o">::</span><span class="n">with_capacity</span><span class="p">(</span><span class="n">BATCHES</span> <span class="o">*</span> <span class="n">SRC_LEN</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">..</span> <span class="n">SRC_LEN</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">b</span><span class="p">.</span><span class="n">iter</span><span class="p">(</span><span class="o">||</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">dst</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">do_std_writes</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">dst</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">BATCHES</span><span class="p">);</span>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_std_vec_writer</span>                           <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">1000</span> <span class="o">|</span> <span class="p">[</span><span class="o">----*****</span><span class="err">#</span><span class="o">*****--------</span><span class="p">]</span>             <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>      <span class="mi">1248</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">588</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_std_vec_writer_inline_always</span>             <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">900</span> <span class="o">|</span>   <span class="p">[</span><span class="o">----*</span><span class="err">#</span><span class="o">***--</span><span class="p">]</span>                        <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>      <span class="mi">1125</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">282</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_std_vec_writer_inline_never</span>              <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">1000</span> <span class="o">|</span>  <span class="p">[</span><span class="o">----***</span><span class="err">#</span><span class="o">*****--------</span><span class="p">]</span>              <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>      <span class="mi">1227</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">516</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Wow. That&rsquo;s pretty terrible. Something weird must be going on with
<code>Vec::push_all</code>. (Maybe that&rsquo;s what caused my serialization benchmarks to slow
1/3?). Lets skip it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">impl</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="n">MyWriter</span> <span class="k">for</span> <span class="n">VecWriter1</span><span class="o">&lt;</span><span class="nl">&#39;a</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="cp">#[inline]</span>
</span><span class='line'>    <span class="k">fn</span> <span class="n">my_write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">IoResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">src_len</span> <span class="o">=</span> <span class="n">src</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">src_len</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="n">dst</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">as_mut_slice</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// we reserved enough room in `dst` to store `src`.</span>
</span><span class='line'>            <span class="n">ptr</span><span class="o">::</span><span class="n">copy_nonoverlapping_memory</span><span class="p">(</span>
</span><span class='line'>                <span class="n">dst</span><span class="p">.</span><span class="n">as_mut_ptr</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">src</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">src_len</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And it looks a bit better, but not perfect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_vec_writer_1</span>                             <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">100</span> <span class="o">|</span>         <span class="p">[</span><span class="o">------*********</span><span class="err">#</span><span class="o">*****--------</span><span class="p">]</span> <span class="o">|</span> <span class="mi">200</span><span class="o">:</span>       <span class="mi">160</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">68</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_vec_writer_1_inline_always</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">100</span> <span class="o">|</span>     <span class="p">[</span><span class="o">--------****</span><span class="err">#</span><span class="o">**--</span><span class="p">]</span>                 <span class="o">|</span> <span class="mi">300</span><span class="o">:</span>       <span class="mi">182</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">79</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_vec_writer_1_inline_never</span>                <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">600</span> <span class="o">|</span>   <span class="p">[</span><span class="o">---****</span><span class="err">#</span><span class="o">**--</span><span class="p">]</span>                       <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">952</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">399</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&rsquo;s even less going on here than before. The only difference is that
reserve call. Commenting it out gets us back to <code>copy_nonoverlapping_memory</code>
territory:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_vec_writer_1</span>                             <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">70</span> <span class="o">|</span> <span class="p">[</span><span class="o">----------------*********</span><span class="err">#</span><span class="o">******-------</span><span class="p">]</span><span class="o">|</span> <span class="mi">100</span><span class="o">:</span>        <span class="mi">89</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">27</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_vec_writer_1_inline_always</span>               <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">50</span> <span class="o">|</span>   <span class="p">[</span><span class="o">-***</span><span class="err">#</span><span class="o">******--</span><span class="p">]</span>                        <span class="o">|</span> <span class="mi">200</span><span class="o">:</span>        <span class="mi">75</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">46</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">writer</span><span class="o">::</span><span class="n">bench_vec_writer_1_inline_never</span>                <span class="p">...</span> <span class="n">bench</span><span class="o">:</span> <span class="mi">500</span> <span class="o">|</span>   <span class="p">[</span><span class="o">--***</span><span class="err">#</span><span class="o">***---</span><span class="p">]</span>                       <span class="o">|</span> <span class="mi">2000</span><span class="o">:</span>       <span class="mi">775</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">433</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately it&rsquo;s getting pretty late, so rather than wait until the next time
to dive into this, I&rsquo;ll leave it up to you all. Does anyone know why <code>reserve</code>
is causing so much trouble here?</p>

<hr />

<p>PS: While I was working on this, I saw
<a href="https://github.com/erickt/rust-serialization-benchmarks/pull/2">stevencheg</a>
submitted a patch to speed up the protocol buffer support. But when I ran the
tests, everything was about 40% slower than the last benchmark
<a href="http://erickt.github.io/blog/2014/11/13/benchmarks-2/">post</a>! Something
happened with Rust&rsquo;s performance over these past couple weeks!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">bincode</span><span class="o">::</span><span class="n">bench_decoder</span>                          <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>      <span class="mi">7682</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">3680</span><span class="p">)</span> <span class="o">=</span> <span class="mi">52</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">bincode</span><span class="o">::</span><span class="n">bench_encoder</span>                          <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>       <span class="mi">516</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">265</span><span class="p">)</span> <span class="o">=</span> <span class="mi">775</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">bincode</span><span class="o">::</span><span class="n">bench_populate</span>                         <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>      <span class="mi">1504</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">324</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">capnp</span><span class="o">::</span><span class="n">bench_deserialize</span>                        <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>       <span class="mi">251</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">140</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1784</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">capnp</span><span class="o">::</span><span class="n">bench_deserialize_packed_unbuffered</span>      <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>      <span class="mi">1344</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">533</span><span class="p">)</span> <span class="o">=</span> <span class="mi">250</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">capnp</span><span class="o">::</span><span class="n">bench_populate</span>                           <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>       <span class="mi">663</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">236</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">capnp</span><span class="o">::</span><span class="n">bench_serialize</span>                          <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>       <span class="mi">144</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">37</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3111</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">capnp</span><span class="o">::</span><span class="n">bench_serialize_packed_unbuffered</span>        <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>       <span class="mi">913</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">436</span><span class="p">)</span> <span class="o">=</span> <span class="mi">369</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">msgpack</span><span class="o">::</span><span class="n">bench_decoder</span>                          <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>      <span class="mi">3411</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">1837</span><span class="p">)</span> <span class="o">=</span> <span class="mi">84</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">msgpack</span><span class="o">::</span><span class="n">bench_encoder</span>                          <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>       <span class="mi">961</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">477</span><span class="p">)</span> <span class="o">=</span> <span class="mi">298</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">msgpack</span><span class="o">::</span><span class="n">bench_populate</span>                         <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>      <span class="mi">1564</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">453</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">bench_decoder</span>                         <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>      <span class="mi">3116</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">1485</span><span class="p">)</span> <span class="o">=</span> <span class="mi">91</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">bench_encoder</span>                         <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>      <span class="mi">1220</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">482</span><span class="p">)</span> <span class="o">=</span> <span class="mi">234</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">bench_populate</span>                        <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>       <span class="mi">942</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">836</span><span class="p">)</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">serialize_json</span><span class="o">::</span><span class="n">bench_decoder</span>                   <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>     <span class="mi">31934</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">16186</span><span class="p">)</span> <span class="o">=</span> <span class="mi">18</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">serialize_json</span><span class="o">::</span><span class="n">bench_encoder</span>                   <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>      <span class="mi">8481</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">3392</span><span class="p">)</span> <span class="o">=</span> <span class="mi">71</span> <span class="n">MB</span><span class="o">/</span><span class="n">s</span>
</span><span class='line'><span class="n">test</span> <span class="n">goser</span><span class="o">::</span><span class="n">serialize_json</span><span class="o">::</span><span class="n">bench_populate</span>                  <span class="p">...</span> <span class="n">bench</span><span class="o">:</span>      <span class="mi">1471</span> <span class="n">ns</span><span class="o">/</span><span class="n">iter</span> <span class="p">(</span><span class="o">+/-</span> <span class="mi">426</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/19/adventures-in-debugging-a-potential-osx-kernel-bug/">Chasing an EPROTOTYPE Through Rust, Sendto, and the OSX Kernel With C-Reduce</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-19T07:35:04-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>7:35 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A slight diversion from my serialization series. Last week, strcat submitted
<a href="https://github.com/rust-lang/rust/pull/18885">#18885</a> pull request, which adds
support for using a <code>Vec</code> as a <code>Writer</code>. Over the weekend I submitted
<a href="https://github.com/rust-lang/rust/pull/18980">#18980</a>, which allows a <code>&amp;[u8]</code>
to be used as a <code>Reader</code>. Overall a pretty simple change. However, when I was
running the test suite, I found that the <code>std::io::net::tcp::write_close_ip4()</code>
test was occasionally failing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="cp">#[test]</span>
</span><span class='line'><span class="k">fn</span> <span class="n">write_close_ip4</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">next_test_ip4</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">acceptor</span> <span class="o">=</span> <span class="n">TcpListener</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">addr</span><span class="p">).</span><span class="n">listen</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">spawn</span><span class="p">(</span><span class="k">proc</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">_stream</span> <span class="o">=</span> <span class="n">TcpStream</span><span class="o">::</span><span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">// Close</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="k">mut</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">acceptor</span><span class="p">.</span><span class="n">accept</span><span class="p">();</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">buf</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'>    <span class="k">loop</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">stream</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Ok</span><span class="p">(..)</span> <span class="o">=&gt;</span> <span class="p">{}</span>
</span><span class='line'>            <span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">assert</span><span class="o">!</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">ConnectionReset</span> <span class="o">||</span>
</span><span class='line'>                        <span class="n">e</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">BrokenPipe</span> <span class="o">||</span>
</span><span class='line'>                        <span class="n">e</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">ConnectionAborted</span><span class="p">,</span>
</span><span class='line'>                        <span class="s">&quot;unknown error: {}&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>write</code> would succeed a few times, then occasionally error with the
<code>unknown error: Protocol wrong type for socket</code>, or the <code>EPROTOTYPE</code> errno.
This is a really surprising error. As far as I know, the only functions that
return that errno are <code>socket</code>, <code>socketpair</code>, and <code>connect</code>. I searched
everywhere, but I couldn&rsquo;t find any documentation suggesting that <code>write</code> would
ever produce that error.</p>

<p>I wasn&rsquo;t the only one who ran into it. bjz opened
<a href="https://github.com/rust-lang/rust/issues/18900">#18900</a> describing the same
problem. One interesting thing to note is they were also on OSX Yosemite.  So I
took a little bit of time to extract out that test from the Rust test suite
into this <a href="https://gist.github.com/erickt/ac1f35e20834aa5d1972">gist</a> and got
someone on #rust-internals to run it on linux for me with this little driver
script:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'>rustc test.rs
</span><span class='line'>
</span><span class='line'><span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">1</span> 1000<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
</span><span class='line'>  ./test tcp::test::write_close_ip4
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>and it didn&rsquo;t error out. So it seems to be system dependent. Further
experimentation showed that if we introduced sleeps or a mutex synchronization
appeared to fix the problem as well. At this point I wasn&rsquo;t sure if this was a
non-issue, a bug in our code, or a bug in the OS. One things for sure though,
if there is a bug, it could be scattered somewhere across the Rust codebase,
which just <code>std::io</code> alone is 20 files at around 12522 lines. It&rsquo;d be a pain to
cut that down to a self contained test case.</p>

<p>Fortunately we&rsquo;ve got <a href="http://embed.cs.utah.edu/creduce/">C-Reduce</a> to help us
out. Back in May <a href="http://www.cs.utah.edu/~regehr/">Professor John Regehr</a> from
the University of Utah came to our
<a href="http://www.meetup.com/Rust-Bay-Area/events/169434302/">Bay Area Rust meetup</a>
 to talk about compiler testing and fuzzing. We recorded the talk, so if you
want to watch it, you can find it
<a href="https://air.mozilla.org/rust-meetup-may-2014/">here</a>. One of the things he
talked about was the tool C-Reduce his research group developed to
automatically cut
out unnecessary lines of code that can still reproduce a bug you&rsquo;re looking
for. While it&rsquo;s written to target C files, it turns out Rust is syntatically
close enough to C that it works out pretty well for it too. All you need is a
single source file and driver script that&rsquo;ll report if the compiled source file
reproduced the bug.</p>

<p>Aside 1: By the way, one of the other things I did this weekend was I put
together a Homebrew
<a href="https://github.com/Homebrew/homebrew/pull/34220">pull request for C-Reduce</a>.
It hasn&rsquo;t landed yet, but you want to use it, you can do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>% brew install https://raw.githubusercontent.com/erickt/homebrew/delta-and-creduce/Library/Formula/delta.rb
</span><span class='line'>% brew install https://raw.githubusercontent.com/erickt/homebrew/delta-and-creduce/Library/Formula/creduce.rb
</span></code></pre></td></tr></table></div></figure>


<p>Hopefully it&rsquo;ll land soon so you&rsquo;ll be able to do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>% brew install creduce
</span></code></pre></td></tr></table></div></figure>


<p>Anyway, back to the story. So we&rsquo;ve got a rather large code base to cover, and
while C-reduce does a pretty good job of trimming away lines, just pointing it
at the entire <code>std</code> module is a bit too much for it to handle in a reasonable
amount of time. It probably needs some more semantic information about Rust to
do a better job of cutting out broad swaths of code.</p>

<p>So I needed to do at least a rough pass to slim down the files. I figured the
problem was probably contained in <code>std::io</code> or <code>std::sys</code>, so I wrote a simple
<code>test.rs</code> that explicitly included those modules as part of the crate (see
this <a href="https://gist.github.com/erickt/ac1f35e20834aa5d1972">gist</a> if you are
interested), and used the pretty printer to merge it into one file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>% rustc --pretty normal test.rs &gt; test.rs
</span></code></pre></td></tr></table></div></figure>


<p>Aside 2: Our pretty printer still has some bugs in it, which I filed:
<a href="https://github.com/rust-lang/rust/issues/19075">19075</a> and
<a href="https://github.com/rust-lang/rust/issues/19077">19077</a>.  Fortunately it was
pretty simple to fix those cases by hand in the generated <code>std.rs</code>, and odds
are good they&rsquo;ll be fixed by the time you might use this process.</p>

<p>Next up, we need a driver script. We can adapt our one from before. The only
special consideration is that we need to make sure to only exit with a return
code of 0 if the version of <code>std.rs</code> we&rsquo;re compiling errors with <code>EPROTOTYPE</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'>rustc <span class="se">\</span>
</span><span class='line'>  -A unused_imports <span class="se">\</span>
</span><span class='line'>  -A unused_unsafe <span class="se">\</span>
</span><span class='line'>  -A non_camel_case_types <span class="se">\</span>
</span><span class='line'>  -A unused_variables <span class="se">\</span>
</span><span class='line'>  --test <span class="se">\</span>
</span><span class='line'>  -o <span class="nb">test</span> <span class="se">\</span>
</span><span class='line'>  test.rs &gt;/dev/null 2&gt;<span class="p">&amp;</span>1
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$?&quot;</span> -ne <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>  <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nv">root</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> i in <span class="k">$(</span>seq <span class="m">1</span> 1000<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
</span><span class='line'>  <span class="nv">$root</span>/timeout.sh <span class="m">5</span> ./test --nocapture tcp::test::write_close_ip4 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">|</span> tee log
</span><span class='line'>  grep <span class="s2">&quot;Protocol wrong type for socket&quot;</span> log
</span><span class='line'>  <span class="nv">RET</span><span class="o">=</span><span class="s2">&quot;$?&quot;</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$RET&quot;</span> -eq <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>          <span class="nb">exit </span>0
</span><span class='line'>  <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$RET&quot;</span> -eq <span class="s2">&quot;143&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>          <span class="nb">exit </span>1
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'>  <span class="nb">echo</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="nb">exit </span>1
</span></code></pre></td></tr></table></div></figure>


<p>I used the helper script
<a href="http://www.ict.griffith.edu.au/anthony/software/timeout.sh">timeout.sh</a> to
time out tests in case C-Reduce accidentally made us an infinite loop.</p>

<p>Finally we&rsquo;re ready to start running C-Reduce:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>% creduce ./driver.sh test.rs
</span><span class='line'><span class="o">===</span>&lt; <span class="m">30598</span> &gt;<span class="o">===</span>
</span><span class='line'>running <span class="m">8</span> interestingness <span class="nb">test</span><span class="o">(</span>s<span class="o">)</span> in <span class="nv">parallel</span>
</span><span class='line'><span class="o">===</span>&lt; pass_blank :: <span class="m">0</span> &gt;<span class="o">===</span>
</span><span class='line'><span class="o">(</span>0.0 %, <span class="m">156170</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">===</span>&lt; pass_clang_binsrch :: replace-function-def-with-decl &gt;<span class="o">===</span>
</span><span class='line'><span class="o">===</span>&lt; pass_clang_binsrch :: remove-unused-function &gt;<span class="o">===</span>
</span><span class='line'><span class="o">===</span>&lt; pass_lines :: <span class="m">0</span> &gt;<span class="o">===</span>
</span><span class='line'><span class="o">(</span>-0.6 %, <span class="m">157231</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>1.2 %, <span class="m">154323</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>3.7 %, <span class="m">150455</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>4.6 %, <span class="m">149074</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>5.5 %, <span class="m">147639</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>6.4 %, <span class="m">146172</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>7.3 %, <span class="m">144881</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>7.7 %, <span class="m">144187</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>9.1 %, <span class="m">141936</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>9.9 %, <span class="m">140706</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>10.3 %, <span class="m">140104</span> bytes<span class="o">)</span>
</span><span class='line'><span class="o">(</span>10.4 %, <span class="m">139998</span> bytes<span class="o">)</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>I let it run in the background for sometime in the background while I did some
other things. When I got back, C-Reduce automatically reduced the file from
153KB to a slim 22KB. I then reran rust with the lints enabled to manually cut
out the dead code C-Reduce failed to remove, and flattened away some
unnecessary structs and methods. I was finally left with:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
</pre></td><td class='code'><pre><code class='rust'><span class='line'><span class="k">extern</span> <span class="n">crate</span> <span class="n">libc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">Ipv4Addr</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">SocketAddr</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">ip</span><span class="o">::</span><span class="n">ToSocketAddr</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">net</span><span class="o">::</span><span class="n">ip</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">io</span><span class="o">::</span><span class="n">test</span><span class="o">::</span><span class="n">next_test_ip4</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">mem</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">num</span><span class="o">::</span><span class="nb">Int</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">os</span><span class="o">::</span><span class="n">errno</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">os</span><span class="o">::</span><span class="n">error_string</span><span class="p">;</span>
</span><span class='line'><span class="kn">use</span> <span class="n">std</span><span class="o">::</span><span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">bind</span><span class="p">(</span><span class="n">addr</span><span class="o">:</span> <span class="n">ip</span><span class="o">::</span><span class="n">SocketAddr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">match</span> <span class="n">libc</span><span class="o">::</span><span class="n">socket</span><span class="p">(</span><span class="n">libc</span><span class="o">::</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">libc</span><span class="o">::</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="o">-</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="n">panic</span><span class="o">!</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">fd</span> <span class="o">=&gt;</span> <span class="n">fd</span><span class="p">,</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">mem</span><span class="o">::</span><span class="n">zeroed</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">addr_to_sockaddr</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">storage</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">addrp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">storage</span> <span class="k">as</span> <span class="o">*</span><span class="kr">const</span> <span class="n">_</span> <span class="k">as</span> <span class="o">*</span><span class="kr">const</span> <span class="n">libc</span><span class="o">::</span><span class="n">sockaddr</span><span class="p">;</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">libc</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">addrp</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="o">-</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="n">panic</span><span class="o">!</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">_</span> <span class="o">=&gt;</span> <span class="n">fd</span><span class="p">,</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">listen</span><span class="p">(</span><span class="n">fd</span><span class="o">:</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">,</span> <span class="n">backlog</span><span class="o">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">libc</span><span class="o">::</span><span class="n">listen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">backlog</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="o">-</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="n">panic</span><span class="o">!</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">_</span> <span class="o">=&gt;</span> <span class="p">{}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">accept</span><span class="p">(</span><span class="n">fd</span><span class="o">:</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">libc</span><span class="o">::</span><span class="n">accept</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ptr</span><span class="o">::</span><span class="n">null_mut</span><span class="p">(),</span> <span class="n">ptr</span><span class="o">::</span><span class="n">null_mut</span><span class="p">());</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">x</span> <span class="p">{</span>
</span><span class='line'>            <span class="o">-</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="n">panic</span><span class="o">!</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">fd</span> <span class="o">=&gt;</span> <span class="n">fd</span><span class="p">,</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="o">:</span> <span class="n">SocketAddr</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">match</span> <span class="n">libc</span><span class="o">::</span><span class="n">socket</span><span class="p">(</span><span class="n">libc</span><span class="o">::</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">libc</span><span class="o">::</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="o">-</span><span class="mi">1</span> <span class="o">=&gt;</span> <span class="n">panic</span><span class="o">!</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">fd</span> <span class="o">=&gt;</span> <span class="n">fd</span><span class="p">,</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">let</span> <span class="k">mut</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">mem</span><span class="o">::</span><span class="n">zeroed</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">addr_to_sockaddr</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">storage</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">addrp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">storage</span> <span class="k">as</span> <span class="o">*</span><span class="kr">const</span> <span class="n">_</span> <span class="k">as</span> <span class="o">*</span><span class="kr">const</span> <span class="n">libc</span><span class="o">::</span><span class="n">sockaddr</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">libc</span><span class="o">::</span><span class="n">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">addrp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fd</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="o">:</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">,</span> <span class="n">buf</span><span class="o">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="kt">uint</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">libc</span><span class="o">::</span><span class="n">send</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span> <span class="k">as</span> <span class="o">*</span><span class="kr">const</span> <span class="n">_</span><span class="p">,</span> <span class="n">len</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">size_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">as</span> <span class="kt">i64</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Err</span><span class="p">(</span><span class="n">errno</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Ok</span><span class="p">(())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="o">:</span> <span class="n">libc</span><span class="o">::</span><span class="n">c_int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">libc</span><span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>        <span class="n">assert_eq</span><span class="o">!</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">addr_to_sockaddr</span><span class="p">(</span><span class="n">addr</span><span class="o">:</span> <span class="n">SocketAddr</span><span class="p">,</span> <span class="n">storage</span><span class="o">:</span> <span class="o">&amp;</span><span class="k">mut</span> <span class="n">libc</span><span class="o">::</span><span class="n">sockaddr_storage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">libc</span><span class="o">::</span><span class="n">socklen_t</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">inaddr</span> <span class="o">=</span> <span class="k">match</span> <span class="n">addr</span><span class="p">.</span><span class="n">ip</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Ipv4Addr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">a</span> <span class="k">as</span> <span class="kt">u32</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="n">b</span> <span class="k">as</span> <span class="kt">u32</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">c</span> <span class="k">as</span> <span class="kt">u32</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">d</span> <span class="k">as</span> <span class="kt">u32</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">libc</span><span class="o">::</span><span class="n">in_addr</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">s_addr</span><span class="o">:</span> <span class="nb">Int</span><span class="o">::</span><span class="n">from_be</span><span class="p">(</span><span class="n">ip</span><span class="p">),</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">_</span> <span class="o">=&gt;</span> <span class="n">panic</span><span class="o">!</span><span class="p">(),</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="k">unsafe</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">_</span> <span class="k">as</span> <span class="o">*</span><span class="k">mut</span> <span class="n">libc</span><span class="o">::</span><span class="n">sockaddr_in</span><span class="p">;</span>
</span><span class='line'>        <span class="p">(</span><span class="o">*</span><span class="n">storage</span><span class="p">).</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">libc</span><span class="o">::</span><span class="n">AF_INET</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">sa_family_t</span><span class="p">;</span>
</span><span class='line'>        <span class="p">(</span><span class="o">*</span><span class="n">storage</span><span class="p">).</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">addr</span><span class="p">.</span><span class="n">port</span><span class="p">.</span><span class="n">to_be</span><span class="p">();</span>
</span><span class='line'>        <span class="p">(</span><span class="o">*</span><span class="n">storage</span><span class="p">).</span><span class="n">sin_addr</span> <span class="o">=</span> <span class="n">inaddr</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">mem</span><span class="o">::</span><span class="n">size_of</span><span class="o">::&lt;</span><span class="n">libc</span><span class="o">::</span><span class="n">sockaddr_in</span><span class="o">&gt;</span><span class="p">();</span>
</span><span class='line'>        <span class="n">len</span> <span class="k">as</span> <span class="n">libc</span><span class="o">::</span><span class="n">socklen_t</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fn</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">next_test_ip4</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="n">listener</span> <span class="o">=</span> <span class="n">bind</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>    <span class="n">listen</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">spawn</span><span class="p">(</span><span class="k">proc</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">addresses</span> <span class="o">=</span> <span class="n">addr</span><span class="p">.</span><span class="n">to_socket_addr_all</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">addr</span> <span class="k">in</span> <span class="n">addresses</span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">let</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>            <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">let</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span><span class='line'>    <span class="k">loop</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">match</span> <span class="n">x</span> <span class="p">{</span>
</span><span class='line'>            <span class="nb">Ok</span><span class="p">(..)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>            <span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="kd">let</span> <span class="n">e</span> <span class="o">=</span> <span class="n">e</span> <span class="k">as</span> <span class="kt">i32</span><span class="p">;</span>
</span><span class='line'>                <span class="n">assert</span><span class="o">!</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">e</span> <span class="o">==</span> <span class="n">libc</span><span class="o">::</span><span class="n">ECONNREFUSED</span> <span class="o">||</span>
</span><span class='line'>                    <span class="n">e</span> <span class="o">==</span> <span class="n">libc</span><span class="o">::</span><span class="n">EPIPE</span> <span class="o">||</span>
</span><span class='line'>                    <span class="n">e</span> <span class="o">==</span> <span class="n">libc</span><span class="o">::</span><span class="n">ECONNABORTED</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&quot;unknown error: {} {}&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">error_string</span><span class="p">(</span><span class="n">e</span> <span class="k">as</span> <span class="kt">uint</span><span class="p">));</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This snippet reproduces the same <code>EPROTOTYPE</code> that we started with at the top
of the post. Pretty cool that we got here without much effort?</p>

<p>Now At this point you might say to yourself that couldn&rsquo;t I have extracted this
out myself?  And yeah, you would be right. This is a pretty much a c-in-rust
implementation of this bug. But what&rsquo;s great about using C-Reduce here is that
I only had to make some very rough guesses about what files were and were not
important to include in my <code>test.rs</code>. Eventually when we get some rust plugins
written for C-Reduce I probably could just point it at the whole <code>libstd</code> let
C-Reduce do it&rsquo;s thing. Doing this by hand can be a pretty long and painful
manual process, especially if we&rsquo;re trying to debug a codegen or runtime bug.
In the past I&rsquo;ve spent hours reducing some codegen bugs down into a small
snippet that C-Reduce was also able to produce in a couple minutes.</p>

<p>The last step with this code was to eliminate Rust from the picture, and
translate this code into C:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;strings.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/socket.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;netinet/in.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;pthread.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;errno.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">do_server</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">server_addr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error socket server&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">bzero</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">));</span>
</span><span class='line'>  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
</span><span class='line'>  <span class="n">server_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">server_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error binding&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span><span class="o">*</span> <span class="nf">do_child_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">unused</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error socket client&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">bzero</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">));</span>
</span><span class='line'>  <span class="n">client_addr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'>  <span class="n">client_addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">INADDR_ANY</span><span class="p">;</span>
</span><span class='line'>  <span class="n">client_addr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9600</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error connect&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;closing client socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error close client socket&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;closed client socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">server_fd</span><span class="p">,</span> <span class="n">client_fd</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">socklen_t</span> <span class="n">client_len</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span> <span class="p">};</span>
</span><span class='line'>  <span class="kt">pthread_t</span> <span class="n">child_thread</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">signal</span><span class="p">(</span><span class="n">SIGPIPE</span><span class="p">,</span> <span class="n">SIG_IGN</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">server_fd</span> <span class="o">=</span> <span class="n">do_server</span><span class="p">();</span>
</span><span class='line'>  <span class="n">rc</span> <span class="o">=</span> <span class="n">listen</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error listen&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">rc</span> <span class="o">=</span> <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">do_child_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error pthread_create&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">client_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>
</span><span class='line'>  <span class="n">client_fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">server_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_len</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">client_fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error accept&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;before send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">rc</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;after send: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EPIPE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">so_type</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">socklen_t</span> <span class="n">so_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">so_type</span><span class="p">);</span>
</span><span class='line'>        <span class="n">getsockopt</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">so_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">so_len</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;type: %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">so_type</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error send&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;before server closing client fd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">client_fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error close client&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;after server closing client fd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;before server closing fd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">close</span><span class="p">(</span><span class="n">server_fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error close server&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;after server closing fd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">rc</span> <span class="o">=</span> <span class="n">pthread_join</span><span class="p">(</span><span class="n">child_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">!=</span> <span class="n">ESRCH</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;error pthread_join: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This also produces <code>EPROTOTYPE</code>, so we can eliminate Rust altogther. But lets
keep digging. What exactly is producing this error? If I was on Linux, I&rsquo;d use
<code>strace</code>, but that program isn&rsquo;t on Macs. There&rsquo;s a similar tool called
<code>dtruss</code>, but that seemed to slow things down enough that the <code>EPROTOTYPE</code>
never happened. Fortunately though there is another program called <code>errinfo</code>,
that just prints the <code>errno</code> along with every syscall. In one terminal I ran
<code>while ./test; do sleep 0.1; done</code>. In the other:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">%</span> <span class="n">sudo</span> <span class="n">errinfo</span> <span class="o">-</span><span class="n">n</span> <span class="n">test</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span>           <span class="n">stat64</span>    <span class="mi">0</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span>             <span class="n">open</span>    <span class="mi">0</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span> <span class="n">psynch_mutexwait</span>    <span class="mi">0</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span>   <span class="n">write_nocancel</span>    <span class="mi">0</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span>           <span class="n">sendto</span>    <span class="mi">0</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span>   <span class="n">write_nocancel</span>    <span class="mi">0</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span>   <span class="n">write_nocancel</span>    <span class="mi">0</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span>           <span class="n">sendto</span>   <span class="mi">41</span>  <span class="n">Protocol</span> <span class="n">wrong</span> <span class="n">type</span> <span class="k">for</span> <span class="n">socket</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span>   <span class="n">write_nocancel</span>    <span class="mi">0</span>
</span><span class='line'>           <span class="n">a</span><span class="p">.</span><span class="n">out</span>       <span class="n">getsockopt</span>    <span class="mi">0</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Right there we see our <code>sendto</code> syscall is actually returning the <code>EPROTOTYPE</code>.
This <code>errno</code> then is definitely being created inside the OSX kernel, not in any
userspace code. Fortunately, most of the Apple kernel, XNU, is open sourced, so
we can dig down to what&rsquo;ll be the my last layer. You can find the tarballs at
<a href="http://www.opensource.apple.com/.">http://www.opensource.apple.com/.</a> But I&rsquo;d rather use the
<a href="https://github.com/opensource-apple/xnu">unoffical GitHub repository</a>. Using GitHub&rsquo;s
search tools, We can find all 17 instances of
<a href="https://github.com/opensource-apple/xnu/search?l=c&amp;q=EPROTOTYPE&amp;utf8=%E2%9C%93">EPROTOTYPE</a>
in the codebase. Now I don&rsquo;t know the XNU codebase, but there are still some
really interesting things we can find. The first is in
<a href="https://github.com/opensource-apple/xnu/blob/bb7368935f659ada117c0889612e379c97eb83b3/bsd/kern/uipc_usrreq.c#L408">bsd/kern/uipc_usrreq.c</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Returns:  0      Success</span>
</span><span class='line'><span class="cm"> *    EINVAL</span>
</span><span class='line'><span class="cm"> *    EOPNOTSUPP</span>
</span><span class='line'><span class="cm"> *    EPIPE</span>
</span><span class='line'><span class="cm"> *    ENOTCONN</span>
</span><span class='line'><span class="cm"> *    EISCONN</span>
</span><span class='line'><span class="cm"> *  unp_internalize:EINVAL</span>
</span><span class='line'><span class="cm"> *  unp_internalize:EBADF</span>
</span><span class='line'><span class="cm"> *  unp_connect:EAFNOSUPPORT  Address family not supported</span>
</span><span class='line'><span class="cm"> *  unp_connect:EINVAL        Invalid argument</span>
</span><span class='line'><span class="cm"> *  unp_connect:ENOTSOCK      Not a socket</span>
</span><span class='line'><span class="cm"> *  unp_connect:ECONNREFUSED  Connection refused</span>
</span><span class='line'><span class="cm"> *  unp_connect:EISCONN       Socket is connected</span>
</span><span class='line'><span class="cm"> *  unp_connect:EPROTOTYPE    Protocol wrong type for socket</span>
</span><span class='line'><span class="cm"> *  unp_connect:???</span>
</span><span class='line'><span class="cm"> *  sbappendaddr:ENOBUFS      [5th argument, contents modified]</span>
</span><span class='line'><span class="cm"> *  sbappendaddr:???          [whatever a filter author chooses]</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">uipc_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">so</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">nam</span><span class="p">,</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">control</span><span class="p">,</span> <span class="kt">proc_t</span> <span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hey look at that! There&rsquo;s handler for the <code>send</code> syscall (although for IPC, not
TCP) that actually documents that it can return <code>EPROTOTYPE</code>! While it doesn&rsquo;t
explain exactly how this can happen, the fact it mentions <code>unp_connect</code> hints
that <code>uipc_send</code> may trigger a connect, and that&rsquo;s exactly what we find a
couple lines into the function:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="cm">/* Connect if not connected yet. */</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Note: A better implementation would complain</span>
</span><span class='line'><span class="cm">     * if not equal to the peer&#39;s address.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">so</span><span class="o">-&gt;</span><span class="n">so_state</span> <span class="o">&amp;</span> <span class="n">SS_ISCONNECTED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">nam</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span> <span class="o">=</span> <span class="n">unp_connect</span><span class="p">(</span><span class="n">so</span><span class="p">,</span> <span class="n">nam</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'>          <span class="k">break</span><span class="p">;</span>  <span class="cm">/* XXX */</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">error</span> <span class="o">=</span> <span class="n">ENOTCONN</span><span class="p">;</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The fact that the comment says the socket might not be connected yet when we&rsquo;re
doing a <code>send</code> hints that Apple may have introduced some level of asynchrony
and preemption to sockets. So if we trigger the actual connect here, it could
then return <code>EPROTOTYPE</code>, which makes sense. Unfortunately that&rsquo;s still not
quite the behavior we&rsquo;re seeing. We&rsquo;re not getting <code>EPROTOTYPE</code> on our first
write, but after we&rsquo;ve done a couple.</p>

<p>I believe we find that behavior in the actual TCP syscall file,
<a href="https://github.com/opensource-apple/xnu/blob/bb7368935f659ada117c0889612e379c97eb83b3/bsd/netinet/tcp_usrreq.c#L914-L948">bsd/netinet/tcp_usrreq.c</a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span>
</span><span class='line'><span class="nf">tcp_usr_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">so</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span>
</span><span class='line'>     <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">nam</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mbuf</span> <span class="o">*</span><span class="n">control</span><span class="p">,</span> <span class="k">struct</span> <span class="n">proc</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">inpcb</span> <span class="o">*</span><span class="n">inp</span> <span class="o">=</span> <span class="n">sotoinpcb</span><span class="p">(</span><span class="n">so</span><span class="p">);</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">tcpcb</span> <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">uint32_t</span> <span class="n">msgpri</span> <span class="o">=</span> <span class="n">MSG_PRI_DEFAULT</span><span class="p">;</span>
</span><span class='line'><span class="cp">#if INET6</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">isipv6</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>  <span class="n">TCPDEBUG0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">inp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">inp</span><span class="o">-&gt;</span><span class="n">inp_state</span> <span class="o">==</span> <span class="n">INPCB_STATE_DEAD</span>
</span><span class='line'><span class="cp">#if NECP</span>
</span><span class='line'>    <span class="o">||</span> <span class="p">(</span><span class="n">necp_socket_should_use_flow_divert</span><span class="p">(</span><span class="n">inp</span><span class="p">))</span>
</span><span class='line'><span class="cp">#endif </span><span class="cm">/* NECP */</span><span class="cp"></span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * OOPS! we lost a race, the TCP session got reset after</span>
</span><span class='line'><span class="cm">     * we checked SS_CANTSENDMORE, eg: while doing uiomove or a</span>
</span><span class='line'><span class="cm">     * network interrupt in the non-splnet() section of sosend().</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="n">m_freem</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">m_freem</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
</span><span class='line'>      <span class="n">control</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">inp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span><span class='line'>      <span class="n">error</span> <span class="o">=</span> <span class="n">ECONNRESET</span><span class="p">;</span>  <span class="cm">/* XXX EPIPE? */</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">error</span> <span class="o">=</span> <span class="n">EPROTOTYPE</span><span class="p">;</span>
</span><span class='line'>    <span class="n">tp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">TCPDEBUG1</span><span class="p">();</span>
</span><span class='line'>    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>I believe that comment explains everything we&rsquo;re seeing. If we trigger a <code>send</code>
while the kernel is in the middle of tearing down the socket, it returns
<code>EPROTOTYPE</code>. This then looks to be an error we could retry. Once the socket is
fully torn down, it should eventually return the proper <code>EPIPE</code>. This is also
pretty easy to test. So I modified the inner loop of our C test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;before send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">rc</span> <span class="o">=</span> <span class="n">send</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;after send: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EPIPE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EPROTOTYPE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">so_type</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">socklen_t</span> <span class="n">so_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">so_type</span><span class="p">);</span>
</span><span class='line'>        <span class="n">getsockopt</span><span class="p">(</span><span class="n">client_fd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">so_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">so_len</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;type: %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">so_type</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;error send&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And yep, it exits cleanly. After all of this, I think it&rsquo;s pretty clear at this
point that there&rsquo;s no weird kernel corruption bug going on, just a poorly
documented edge case. But it sure was fun chasing this condition through the
system.</p>

<p>To prevent anyone else from tripping over this edge case, I filed a Apple Radar
ticket (number #19012087 for any Apple employees reading this). Hopefully if
anyone runs into this mysterious <code>EPROTOTYPE</code> it&rsquo;ll be documented for them, or
at least there&rsquo;s a chance they&rsquo;ll stumble over this blog post and save
themselves a weekend diving through the OS.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/11/13/benchmarks-2/">Rewriting Rust Serialization, Part 2.2: More Benchmarks</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-13T09:07:36-08:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>9:07 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Back to the benchmarks! I got some great comments on
<a href="https://www.reddit.com/r/rust/comments/2lzc9n/rust_serialization_part_21_now_with_more/">reddit</a>,
So I wanted to do another post to update my numbers. Here&rsquo;s what I changed:</p>

<ul>
<li>I wasn&rsquo;t consistent on whether or not the serialization benchmarks included
Some tests are including the allocation of a buffer to write into. I&rsquo;ve
  changed it so most are reusing one, which speeds everything up (especially
capnproto-rust!). This does depend on
<a href="https://github.com/rust-lang/rust/pull/18885">#18885</a> landing though.</li>
<li>I&rsquo;ve added <a href="https://github.com/TyOverby/bincode">bincode</a>, which serializes
values as raw bytes. Quite speedy too! Not nearly as fast as Cap&#8217;n Proto though.</li>
<li>I&rsquo;ve changed <code>C++</code> and <code>Rust</code> JSON tests to serialize enums as uints.</li>
<li>I added the time it takes to create the populate the structures. I&rsquo;m betting
  the reason the Rust numbers are so high is that we&rsquo;re allocating strings. Not
sure if the other languages are able to avoid that allocation.</li>
</ul>


<hr />

<p>JSON:</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library         </th>
<th> population (ns) </th>
<th> serialization (MB/s) </th>
<th> deserialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> Rust     </td>
<td> serialize::json </td>
<td> 1127            </td>
<td> 117                  </td>
<td> 26                     </td>
</tr>
<tr>
<td> C++      </td>
<td> rapidjson (dom) </td>
<td> 546             </td>
<td> 281                  </td>
<td> 144                    </td>
</tr>
<tr>
<td> C++      </td>
<td> rapidjson (dom) </td>
<td> 546             </td>
<td> 281                  </td>
<td> 181                    </td>
</tr>
<tr>
<td> Go       </td>
<td> encoding/json   </td>
<td> 343             </td>
<td> 63.99                </td>
<td> 22.46                  </td>
</tr>
<tr>
<td> Go       </td>
<td> ffjson          </td>
<td> 343             </td>
<td> 144.60               </td>
<td> (not supported)        </td>
</tr>
</tbody>
</table>


<hr />

<p>Cap&#8217;n Proto:</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library                   </th>
<th> population (ns) </th>
<th> serialization (MB/s) </th>
<th> deserialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> Rust     </td>
<td> capnproto-rust (unpacked) </td>
<td> 325             </td>
<td> 4977                 </td>
<td> 2251                   </td>
</tr>
<tr>
<td> Rust     </td>
<td> capnproto-rust (packed)   </td>
<td> 325             </td>
<td> 398                  </td>
<td> 246                    </td>
</tr>
<tr>
<td> Go       </td>
<td> go-capnproto              </td>
<td> 2368            </td>
<td> 2226.71              </td>
<td> 450                    </td>
</tr>
<tr>
<td> Go       </td>
<td> go-capnproto (zero copy)  </td>
<td> 2368            </td>
<td> 2226.71              </td>
<td> 1393.3                 </td>
</tr>
</tbody>
</table>


<hr />

<p>Protocol Buffers:</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library       </th>
<th> population (ns) </th>
<th> serialization (MB/s) </th>
<th> deserialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> Rust     </td>
<td> rust-protobuf </td>
<td> 1041            </td>
<td> 370                  </td>
<td> 118                    </td>
</tr>
<tr>
<td> Go       </td>
<td> goprotobuf    </td>
<td> 1133            </td>
<td> 138.27               </td>
<td> 91.18                  </td>
</tr>
<tr>
<td> Go       </td>
<td> gogoprotobuf  </td>
<td> 343             </td>
<td> 472.69               </td>
<td> 295.33                 </td>
</tr>
</tbody>
</table>


<hr />

<p>Misc:</p>

<table>
<thead>
<tr>
<th> language </th>
<th> library      </th>
<th> population (ns) </th>
<th> serialization (MB/s) </th>
<th> deserialization (MB/s) </th>
</tr>
</thead>
<tbody>
<tr>
<td> Rust     </td>
<td> rust-msgpack </td>
<td> 1143            </td>
<td> 454                  </td>
<td> 144                    </td>
</tr>
<tr>
<td> Rust     </td>
<td> bincode      </td>
<td> 1143            </td>
<td> 1149                 </td>
<td> 82                     </td>
</tr>
</tbody>
</table>


<p>Anyone want to add more C/Go/Rust/Java/etc benchmarks?</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/04/12/serde-0-dot-3-1-now-compatible-with-beta/">Serde 0.3.1 - Now Compatible With Beta! Plus Aster and Quasi Updates</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/31/serde-0-dot-3/">Serde 0.3</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/16/rewriting-rust-serialization-there-can-be-only-one-serde/">Rewriting Rust Serialization: Part 4: Serde2 Is Ready!</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/09/syntex-syntex-extensions-for-rust-1-dot-0/">Syntex: Syntax Extensions for Rust 1.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/12/13/performance-digression/">Rewriting Rust Serialization, Part 3.1: Another Performance Digression</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/erickt">@erickt</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'erickt',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Erick Tryzelaar -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
